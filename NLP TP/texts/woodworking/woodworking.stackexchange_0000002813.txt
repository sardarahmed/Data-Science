Q:

Should I finish before, during, or after assembly?

I'm building some pretty basic bookshelves. I intend to assemble them with glue. I also intend to sand them, apply stain, shellac, and polyurethane.
Should I: Dry fit, glue, sand, finish? Or dry fit, sand, stain, glue, shellac, polyurethane? Or some other order? In your experience what order leads to the least amount of mistakes?
Sometimes when I finish after assembly it's hard to get in tight places, or e.g. apply polyurethane on vertical surfaces without it thickening at the bottom, etc. It is also hard to sand in corners. But if I finish first it interferes with glue and I sometimes damage the finish. I can't find a good technique.

A:

Yes, yes and yes. I think some pre-finishing should be done almost routinely, but doing so is not nearly as common as it could be. 
It should be said that the type of the finish plays a big part in how important pre-finishing can be, if you're wiping on a penetrating finish for example it's far less beneficial than it would be if you were spraying lacquer where hard-to-reach can in fact become impossible-to-finish.
Regardless of finish type though, one very important aspect of any degree of pre-finishing is protecting your mating surfaces as you touch on in the Question. Joints must remain bare wood or the strength of the glued join is severely compromised.

Should I: Dry fit, glue, sand, finish? Or dry fit, sand, stain, glue, shellac, polyurethane? Or some other order? In your experience what order leads to the least amount of mistakes?

It very much depends on the size and complexity of the piece. For a simple jewellery box for example no finishing prior to final assembly will generally make it any easier to complete the box. 
Since you asked about bookshelves, on shelving units that have moveable shelves the shelves are commonly finished ahead of the case, simply because otherwise you don't have access to all six sides of the board. And if doing that it makes sense to finish the interior while the shelves aren't there to get in the way, and then of course there's no reason not to tackle the outside surfaces while you're at it. Last step then would be to install the finished shelves into the finished case. But on a shelving unit with fixed shelves applying finish after final assembly wouldn't be unusual; that's not to say it should be done this way, pre-finish if you find it beneficial.
Frame-and-panel work is a good example of where some pre-finishing really has to be done for a good result. If you don't finish the panel prior to fitting it into the frame any shrinkage later on it will reveal unfinished wood at the edges which is very unsightly:

But if I finish first it interferes with glue 

As mentioned above this is very important, the joint faces must not have finish on them. Being careful with how you apply the finish is a start, but if you want to be thorough then it's worth taking the time to protect them (all of them) with tape prior to the application of any finish.
So you tape as much as the project requires, from a little:

To a lot:

and I sometimes damage the finish. 

This is the area where I think pre-finishing presents a definite challenge. There's always the chance of some slight damage while manoeuvring pre-finished parts, particularly since we'd normally be handling the pieces long before the finish has achieved its final hardness (this can take weeks).
Obvious advice is to work very carefully and mindfully but everyone can make a mistake so some precautions can certainly be advisable. One that is sometimes used is to cover the bench or assembly table with something soft, e.g. with a clean scrap of carpet or a blanket. This should slightly overhang the front edge so that a bump there isn't a wood-on-wood contact. Some woodworkers even have carpet-lined vice jaws (as part of a set of removable jaws) to be able to hold finished pieces in the vice if necessary.

Couple of bits unrelated to the main question:

apply polyurethane on vertical surfaces without it thickening at the bottom, 

Highly recommend trying wiping application. Simply thin your regular poly in a clean container and you convert it into "wiping varnish". Then wipe it on. 
It builds finish more slowly but it's a great way to apply varnish to a high standard, avoiding many of the common pitfalls.

It is also hard to sand in corners. 

Finish shouldn't normally need sanding, except to de-nib. Despite how commonly this is stated sanding between coats is not required for adhesion.

A:

The answer is "yes". Depends on the piece, finish, tools and your preferred way of working.
It's common to pre-finish parts that will be hard to reach after assembly, It's common to finish sub-components like doors, especially when you havd many of them and can work assembly line style.
Outside of that, as you say, it's all trade-offs. Prefinishing means some risk of marring dut=ring assembly, of not getting as good an appearance match between adjacent parts that should present as a single structure, and if you are incautioUs and get finish on the glue surfaces that will weaken the bond. And some pieces --  doors are a good example again -- can't be trimmed to final size until partway through assembly, so even if you finish spme faces earlybyou may need to finish others much later.
The right answer is the one that works best for you, on this piece, at this time. You aren't going to ruin the piece either way, so go ahead and experiment.

