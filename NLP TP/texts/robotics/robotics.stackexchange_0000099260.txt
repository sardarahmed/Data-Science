Q:

Galactic/Fast-DDS middleware can't loan messages

I am using ROS 2 galactic and running with my environment set for FastRTPS middleware.  I am using the loaned message buffer API and the XML configuration for shared memory described in the Fast-DDS documentation (snippet):
<transport_descriptors>
    <!-- Create a descriptor for the new transport -->
    <transport_descriptor>
        <transport_id>shm_transport</transport_id>
        <type>SHM</type>
    </transport_descriptor>
</transport_descriptors>

<participant profile_name="SHMParticipant" is_default_profile="true">
    <rtps>
        <!-- Link the Transport Layer to the Participant -->
        <userTransports>
            <transport_id>shm_transport</transport_id>
        </userTransports>
    </rtps>
</participant>

When I run my publish code, I get the following output:

Currently used middleware can't loan messages. Local allocator will be used.

My testing shows that latency is increasing as data size increases so it appears that it really isn't using zero copy.
Code can be found at: https://github.com/mschickler/simple_perf
It was announced in ROS discourse that the latest Fast-DDS supported zero copy / shared memory.  Am I doing something wrong?  Does the rmw layer not yet support the new functionality?  Any ideas?

Originally posted by mschickler on ROS Answers with karma: 95 on 2021-06-14
Post score: 1

A:

As far as I'm aware, FastDDS does not support the loaned messages, and performs their shared memory transport in some other method.
The loaned message API is used in iceoryx right now, which does work with CycloneDDS.

Originally posted by allenh1 with karma: 3055 on 2021-06-15
This answer was ACCEPTED on the original site
Post score: 1

Original comments
Comment by mschickler on 2021-06-15:
Do you know how I would go about configuring to use Cyclone DDS with iceoryx integration?  When I try this test with default RMW (Cyclone) the results still don't look like zero copy is happening.
Comment by allenh1 on 2021-06-15:
Yep -- it's not on by default, but you can read about it here, it's pretty painless.
Comment by budrus on 2021-06-15:
There is also additional documentation in rmw_cyclonedds. Also note that the patch release 1 for Galactic should be released in the next 2 weeks and does include improvements and bug fixes for the zero-copy case
Comment by mschickler on 2021-06-15:
Thanks folks.  Appreciate the help!

