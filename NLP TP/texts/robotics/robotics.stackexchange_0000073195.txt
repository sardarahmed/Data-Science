Q:

RTabMap map disappearing

Hi All,
I am trying to make a 3D map of my office as the first step in a new project involving 3D mapping using an Intel Realsense F200 RGBD camera. I've got the camera working and am tweaking parameters in rtabmap_ros. I am having an issue though with the map disappearing. I've set time_threshold to 0 in as apparently that can make older parts of the map disappear. I've also set map_filter_rad to 0 for the same reason. Neither of these worked however, I can still only see what the camera sees at that time. If anyone knows how to fix this I would greatly appreciate the help.
Thanks
[EDIT]
I am getting a cloud map in RVIZ now, but the coloured map that should show up in rtabmapviz is still only showing me what is in the camera's view at that moment. Areas that fall out of view as I move the camera disappear.
[EDIT2]
For some reason I couldn't upload the db here so I have made a github repo with it and the launch file I am using at https://github.com/NCharabaruk/rtabmap_help.git

Originally posted by Icehawk101 on ROS Answers with karma: 955 on 2016-04-04
Post score: 0

Original comments
Comment by matlabbe on 2016-04-04:
If you subscribe to /rtabmap/cloud_map in RVIZ, do you see something? If you see only the current camera cloud, the map may not be published. Do you have warnings on the terminal?
Comment by Icehawk101 on 2016-04-04:
You are most wise. I am not in fact receiving a map. The terminal states
 [ WARN] [1459799675.240846585]: Cloud map is empty! (clouds=64)

Comment by matlabbe on 2016-04-06:
Can you post the generated database of a small scan? (see ~/.ros/rtabmap.db)

A:

Hi,
When the generated clouds  are empty, it may because the intrinsic parameters (focals) of camera_info are wrong or the depth image format is not standard (rtabmap wants 16bits unsigned short = mm or 32bits float = meters). For example, if you have distance in mm in float format, the point cloud will be 1000x bigger. By default, cloud_max_depth is 4 meters (thus filtering all points of the previous case). You could try to set
cloud_max_depth to 0 (filtering disabled) to see if the clouds can be generated (even if the calibration is wrong).
EDIT1: In rtabmapviz, the maximum depth parameter for the map is under Preferences->3D Rendering.
EDIT2: You may debug the depth image scale by showing the cloud using DepthCloud display in RVIZ instead of PointCloud2.
EDIT3: The database contains a map, though the depth image is not registered with the RGB image (see image below). The depth scale is large (like between 10 meters to ~40 meters). The calibration looks ok though (640x480 fx=617.326 fy=617.326 cx=321.177 cy=245.512).

cheers

Originally posted by matlabbe with karma: 6409 on 2016-04-04
This answer was ACCEPTED on the original site
Post score: 1

Original comments
Comment by Icehawk101 on 2016-04-05:
I recalibrated the camera and changed cloud_max_depth to 0. It looks like crap, but the point cloud stays. The map in rtabmapviz still disappears though.Now to play with the parameters some more. Thanks for the help!
Comment by Icehawk101 on 2016-04-07:
Hmm, it's weird that the map is in the db but not showing on the screen. The registration is a bit of an issue with the Realsense right now so I've set it aside for the moment. Thanks for your help!

