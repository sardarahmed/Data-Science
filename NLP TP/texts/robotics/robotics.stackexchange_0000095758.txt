Q:

Is it bad practice to declare variables in a callback?

Hi all,
I would like to know if I should avoid creating new variables in a callback function since the callback will be executed each time I receive new data, thus creating a new variable again and again.
Thanks

Originally posted by rosberrypi on ROS Answers with karma: 75 on 2020-05-06
Post score: 0

A:

Performance is a black art and at the end of the day, you have to profile it to be sure. Don't worry about performance until you have reason to believe it's an issue.
That said, it's not bad practice. In fact it's good practice to keep variable declarations close to their usage to avoid accidental shared mutable state. Variables on the stack are super lightweight - even if a variable is in a tight loop, declaring the variable inside the loop will not be an issue, since the compiler will generally optimize it out.
Only when the object is (entirely or partly) on the heap or involves contended resources like locks will there be a performance impact and you should measure it to see if the impact is even worth worrying about.

Originally posted by DanRose with karma: 274 on 2020-05-06
This answer was ACCEPTED on the original site
Post score: 2

Original comments
Comment by gvdhoorn on 2020-05-06:
Just to add some ROS-flavour to this answer (or ROS 1): never create Publishers, Subscribers or Action servers or clients in callbacks. Nor NodeHandles or TF Listeners or Buffers.
It's perhaps not the kind of performance which @rosberry is asking about, nor what @DanRose is writing about, but creating entities in callbacks for which the initialisation and/or correct functioning takes time/depends on how long ago they were created is not a good idea and will most of the times not work.
Setting up subscriptions, publications and action servers and clients as well as TF buffers takes time. Your callback typically doesn't give it that time, so things will not work.

Edit: and yes, I wrote "never" there. As this is software, and the search space is almost unlimited, you will most likely come across situations or code where it is actually necessary or beneficial to create those kinds of entities in callbacks. By all means do. This is just general advice.
Comment by rosberrypi on 2020-05-07:
Thank you both for the explanations, it was very helpful.

