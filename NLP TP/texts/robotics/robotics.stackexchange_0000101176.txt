Q:

rtabmap obstacle_detection error: lookup would require extrapolation into the future when looking up transform

Hi everyone, I have a problem with using rtabmap obstacle_detection nodelet, I get the following error when trying to read the published topic ( in my case called /pointCloud_obstacles):
   [ERROR]  Lookup would require extrapolation -0.120000000s into the future.  Requested time 1027.127000000 but the latest data is at time 1027.007000000, when looking up transform from frame [base_link] to frame [map]

The difference in the two times is always about 0.1 (seconds?) and it's also interesting how it says that it require extrapolation of a negative time into the future, so it seems more the past than the future.
I don't get any error if I do not access the topic (e.g. using rostopic hz or another node).
This is the relevant part of the tf tree:

This is my launch file, mainly taken from rtabmap outdoor mapping tutorial and from rtabmap outdoor navigation tutorial:
   <param name="use_sim_time" type="bool" value="true"/>

   <!--

   --> 
   <!-- Stereo Odometry -->   
   <node pkg="rtabmap_ros" type="stereo_odometry" name="stereo_odometry" output="screen">
      <remap from="left/image_rect"       to="/zed2/left/image_rect_color"/>
      <remap from="right/image_rect"      to="/zed2/right/image_rect_color"/>
      <remap from="left/camera_info"      to="/zed2/left/camera_info"/>
      <remap from="right/camera_info"     to="/zed2/right/camera_info"/>
      
      <param name="frame_id" type="string" value="base_footprint"/>
      <param name="queue_size" type="int" value="20"/>
      <param name="odom_frame_id" type="string" value="odom"/>
      <param name="wait_for_transform" type="bool" value="true"/>

      <param name="Odom/Strategy" type="string" value="0"/> <!-- 0=BOW, 1=OpticalFlow -->
      <param name="Odom/EstimationType" type="string" value="1"/> <!-- 3D->2D (PnP) -->
      <param name="Odom/MinInliers" type="string" value="10"/>
      <param name="Odom/RoiRatios" type="string" value="0.03 0.03 0.04 0.04"/>
      <param name="Odom/MaxDepth" type="string" value="10"/>
      <param name="OdomBow/NNDR" type="string" value="0.8"/>
      <param name="Odom/MaxFeatures" type="string" value="1000"/>
      <param name="Odom/FillInfoData" type="string" value="$(arg rtabmapviz)"/>
      <param name="GFTT/MinDistance" type="string" value="10"/>
      <param name="GFTT/QualityLevel" type="string" value="0.00001"/> 
   </node>
     

   <group ns="rtabmap">   
      <!-- Visual SLAM: args: "delete_db_on_start" and "udebug" -->
      <node name="rtabmap" pkg="rtabmap_ros" type="rtabmap" output="screen" args="--delete_db_on_start">
         <param name="frame_id" type="string" value="zed2_camera_center"/>
         <param name="subscribe_stereo" type="bool" value="true"/>
         <param name="subscribe_depth" type="bool" value="true"/>

         <remap from="odom" to="/odom"/>

         <param name="queue_size" type="int" value="30"/>
         <remap from="left/image_rect" to="/zed2/left/image_rect_color"/>
         <remap from="right/image_rect" to="/zed2/right/image_rect_color"/>
         <remap from="left/camera_info" to="/zed2/left/camera_info"/>
         <remap from="right/camera_info" to="/zed2/right/camera_info"/>
         <!-- RTAB-Map's parameters -->
         <param name="Rtabmap/TimeThr" type="string" value="700"/>
         <param name="Rtabmap/DetectionRate" type="string" value="1"/>
         
         <param name="Kp/MaxFeatures" type="string" value="200"/>
         <param name="Kp/RoiRatios" type="string" value="0.03 0.03 0.04 0.04"/>
         <param name="Kp/DetectorStrategy" type="string" value="0"/>   <!-- use SURF -->
         <param name="Kp/NNStrategy" type="string" value="1"/>         <!-- kdTree -->

         <param name="SURF/HessianThreshold" type="string" value="1000"/>

         <param name="Vis/MinInliers" type="string" value="10"/>
         <param name="Vis/EstimationType" type="string" value="1"/> <!-- 3D->2D (PnP) -->

         <param name="RGBD/LoopClosureReextractFeatures" type="string" value="true"/>
         <param name="Vis/MaxWords" type="string" value="500"/>
         <param name="Vis/MaxDepth" type="string" value="10"/> 

         <param name="approx_sync" type="bool" value="true"/>

         <param name="RGBD/CreateOccupancyGrid" value="false"/>
      </node>

   <!-- nodelet manager -->
   <node pkg="nodelet" type="nodelet" name="stereo_nodelet"  args="manager"/>
  
   <!-- downsample pointcloud -->
   <node pkg="nodelet" type="nodelet" name="points_xyz" args="standalone rtabmap_ros/point_cloud_xyz">
   <remap from="depth/image"         to="/zed2/depth/depth_registered"/>
   <remap from="depth/camera_info"   to="/zed2/depth/camera_info"/>
   <remap from="cloud"               to="/pointCloud_downsample" />
   <param name="decimation"  type="double" value="4"/>
   <param name="voxel_size"  type="double" value="0.05"/>
   <param name="approx_sync" type="bool" value="true"/>
   </node>
   
  ##THIS NODE CREATES PROBLEM
   <node pkg="nodelet" type="nodelet" name="obstacles_detection"
    args="load rtabmap_ros/obstacles_detection stereo_nodelet">
      <remap from="cloud" to="/pointCloud_downsample"/>
      <remap from="obstacles" to="/pointCloud_obstacles"/>
      <param name="use_sim_time" type="bool" value="true"/>
      <param name="frame_id" type="string" value="base_footprint"/>
      <param name="map_frame_id" type="string" value="map"/>
      <param name="Grid/MinClusterSize" type="int" value="5"/>
      <param name="Grid/ClusterRadius"       type="double" value="0.1"/>
      <param name="Grid/MaxObstaclesHeight" type="double" value="0.5"/>  
   </node>
   

All the code is run into the same machine so it should not be a synchronization issue.
I found online that the problem could be due to the simulation time, I tried to set the parameter sim_time to true but I don't know if I did it in the correct way.

Originally posted by AlessioParmeggiani on ROS Answers with karma: 165 on 2022-02-06
Post score: 2

Original comments
Comment by osilva on 2022-02-07:
Hi @parmex, please take a look at this previous question #q357836 and please share the things that you have discarded. Please check both answers.
Comment by AlessioParmeggiani on 2022-02-08:
Hi @osilva,thank you for the suggestion! I already looked at that question and I found some hint on what could cause the problem but sadly not how to solve it.
Anyway, I marked as accepted the answer below, as it solves my issue :)

A:

It looks like waitForTransform is false by default here. Try adding wait_for_transform parameter to obstacles_detection nodelet:
 <node pkg="nodelet" type="nodelet" name="obstacles_detection"
    args="load rtabmap_ros/obstacles_detection stereo_nodelet">
      <remap from="cloud" to="/pointCloud_downsample"/>
      <remap from="obstacles" to="/pointCloud_obstacles"/>
      <param name="use_sim_time" type="bool" value="true"/>
      <param name="frame_id" type="string" value="base_footprint"/>
      <param name="map_frame_id" type="string" value="map"/>
      <param name="wait_for_transform" type="bool" value="true"/>
      <param name="Grid/MinClusterSize" type="int" value="5"/>
      <param name="Grid/ClusterRadius"       type="double" value="0.1"/>
      <param name="Grid/MaxObstaclesHeight" type="double" value="0.5"/>  
   </node>

The error happens because it is receiving the point cloud before odometry has been completely computed, so it has to wait a little to get TF at that stamp.

Originally posted by matlabbe with karma: 6409 on 2022-02-07
This answer was ACCEPTED on the original site
Post score: 1

Original comments
Comment by AlessioParmeggiani on 2022-02-08:
Thank you so much! This solved the problem! :)

