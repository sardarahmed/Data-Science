Q:

Cannot create a rclcpp::spin function

Hi all,
I am having a trouble in publishing and subscribing the node at the same time. More specifically, I am having an issue to pass the shared_ptr to the rclcpp::spin function. Here is my function inside my class:
void OdomNode::update()
{
    //std::shared_ptr<rclcpp::Node> _for_spin = std::make_shared<rclcpp::Node>(*this);
    while(rclcpp::ok())
    {
        this->loop();
        this->_loop_rate.sleep();
        rclcpp::spin(*this);
    }
}
 

As you can see, the object itself inherits from rclcpp::Node class and this is a node instance. I have tried to use the first (uncommented) choice but it would not compile saying that the variable is private in this context (not sure what private there exactly). I have also tried to pass shared_from_this but during the runtime it crashes saying that it is a bad_weak_ptr.

Originally posted by EdwardNur on ROS Answers with karma: 115 on 2019-08-08
Post score: 0

A:

@jdlangs is correct that shared_from_this() is the correct way to get a shared pointer to the node.
Besides the compilation issue, your code looks troublesome. rclcpp::spin() is a blocking function, so this->loop() will only be called once. You could try using rclcpp::spin_some() instead, but I suggest that you call rclcpp::spin() from outside your node, for example in a main function like this:
int main(int argc, char ** argv)
{
  rclcpp::init(argc, argv);

  auto odom_node = std::make_shared<OdomNode>();
  rclcpp::spin(odom_node);

  rclcpp::shutdown();
  return 0;
}

And perhaps start a timer to replace your update method, for example in the constructor:
OdomNode::OdomNode(rclcpp::Duration & loop_rate)
{
  timer_ = this->create_wall_timer(loop_rate.to_chrono(), std::bind(&OdomNode::loop, this));
}

This is the pattern you'll find in many of the examples and demos.
This helps make your node more flexible. For example, it leaves open the possibility to compose your node with others into a single process, or easily change the type of executor or callback group.

Originally posted by jacobperron with karma: 1870 on 2019-09-10
This answer was ACCEPTED on the original site
Post score: 0

