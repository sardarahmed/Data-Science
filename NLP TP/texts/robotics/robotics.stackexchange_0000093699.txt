Q:

Autoware ROSBAG Demo doesn't work as expected

Hi guys, i'm trying to create a ndt_mapping using our bag file, but isn't successful.
First, according to this page
(here)

Go to Simulation tab and select arosbag
Click "Play" and click "Pause
Click Computing tab and select ndt_mapping
Click RViz button
Go back to Simulation tab and click Pause to start mapping

And no point cloud is shown in rviz.
I test the ROSBAG Demo according to this page
(here)
And no point cloud is shown in rviz, too.
I using ubuntu 18.04/melodic
Autoware:1.12 (use source install)

Originally posted by scarlet191101 on ROS Answers with karma: 3 on 2019-11-01
Post score: 0

Original comments
Comment by Kenji Miyake on 2019-11-02:
To visualize using rviz, you should set TFs properly. I guess this is the cause.
Could you try these additional steps?

Click "TF" in Setup tab

for /base_link to /velodyne

Click "TF" in Map tab after Referencing tf.launch in sample moriyama data

for /world to /map

Re-launch ndt_mapping

Just in case

If not resolved, please give us these information.

Results of rosrun tf view_frames (frames.pdf)
ScreenShots of your runtime_manager and rviz
(If any error message is shown in rviz) the error messages

Comment by Kenji Miyake on 2019-11-08:
@scarlet191101 Have you solved this problem?
Comment by scarlet191101 on 2019-11-08:
I don’t have much time to try recently.
Click "TF" I have tried, but it is not effective
I don’t know why I often crash when I last tested.
I will test it when I have time.
Thank you~
Comment by avdev on 2019-11-13:
same issue as above. I tried your suggestions but got this error when relaunching MAP.
RLException: while processing /home//.autoware/data/tf/tf.launch:
Invalid roslaunch XML syntax: [Errno 2] No such file or directory: u'/home//.autoware/data/tf/tf.launch'
answers to your questions above.
1)
dot - graphviz version 2.40.1 (20161225.0304)
Detected dot version 2.40
frames.pdf generated
I don't know how to attach a file here but here is a cut and paste of the .pdf.  It shows world connected to map and base_link connected to velodyne.
Recorded at time: 1427157851.432
world
base_link
Broadcaster: /world_to_map
Average rate: 99.505 Hz
Most recent transform: 1573667449.140 ( -146509597.709 sec old)
Buffer length: 4.985 sec
map
Broadcaster: /base_link_to_localizer
Average rate: 99.533 Hz
Most recent transform: 1573667449.141 ( -146509597.710 sec old)
Buffer length: 4.983 sec
velodyne

don't know how to attach screen shot here

Comment by avdev on 2019-11-13:
3) Rviz error: TF: No transform from [base_link] to frame [world]
No transform from [velodyne] to frame [world]
Points Raw:
For frame [velodyne]: No transform to fixed frame [world].  TF error: [Lookup would require extrapolation into the past.  Requested time 1427157850.433733120 but the earliest data is at time 1573666846.142417109, when looking up transform from frame [velodyne] to frame [world]]
Comment by Kenji Miyake on 2019-11-14:
@avdev Thank you for giving the information. If possible, could you upload the data to Google Drive or some online storage services and share the link?
As for the error, I think the cause is you are launching nodes BEFORE starting rosbag play.
When we play rosbag, rosparam use_sim_time will be true.
We need to launch nodes after that in order to use the simulation time.
Comment by avdev on 2019-11-17:
Kenji-
Thanks for the feedback.
I tired it again making sure to start the rosbag play before launching the map node.  I am not sure how to check the use_sim_time.
Here are the screen shots and .pdf you asked for.
https://drive.google.com/drive/folders/1fkE1XuuLg_w_SQFdljGpYLVUIDAYQaJJ?usp=sharing
A second problem that I did not mention earlier is that RuntimeManager has screen tearing making it hard to do more than 2 steps.  Any ideas there?
Comment by avdev on 2019-11-17:
also I did not find the tf.launch in sample moriyama data but used this instead for #2 in your suggestions.
/home//autoware.ai/src/autoware/documentation/autoware_quickstart_examples/launch/tf_local.launch
Comment by Kenji Miyake on 2019-11-18:
@avdev Thank you for the additional information.

I am not sure how to check the use_sim_time.

It's automatically set if you use runtime_manager.
This message will be shown in the console: ['rosparam', 'set', '/use_sim_time', 'true'].

RuntimeManager has screen tearing

It's a known issue in Autoware.AI v1.12 and currently fixed. https://gitlab.com/autowarefoundation/autoware.ai/utilities/issues/2
There are 3 options to fix this.

Use master instead of v1.12
Apply patch to runtime_manager according to the MR
Wait until v1.13 is released (the beginning of December)

I did not find the tf.launch

Please see this page carefully.
https://gitlab.com/autowarefoundation/autoware.ai/autoware/wikis/ROSBAG-Demo
You can download the tf.launch with map files from this link.
1. Download the sample 3D pointcloud/vector map data. [link]
Comment by avdev on 2019-11-21:
Screen tearing is fixed when using the "master" branch.
I now have tf.launch and reference it in TF map.  As well as clicking TF in Setup.  But still no RViz display.  See screenshots from _191121.
https://drive.google.com/open?id=13_ihoSFdrodrypkyhQsMyWZbr4YeWrg3
Comment by Kenji Miyake on 2019-11-22:
Could you show me the output of rosnode list? I think you forgot running ndt_mapping (or, ndt_matching). It's publishing the TF between map to base_link.
Comment by avdev on 2019-11-23:
/base_link_to_localizer
/play_1574545125653620476
/rosout
/runime_manager_2761_1574544625473
/rviz_1574544661393343287
still no point cloud in RViz.  I tried ndt_mapping, ndt_matching, and both together, all with the TF clicked on setup and map tabs.
Comment by Kenji Miyake on 2019-11-24:
Probably it's not working. You need to publish PointCloud to make ndt_* work.
Could you record your operation video?
Comment by avdev on 2019-11-24:
Kenji - I really appreciate your help.
I am not sure how to publish PointCloud.
https://drive.google.com/open?id=1fkE1XuuLg_w_SQFdljGpYLVUIDAYQaJJ
Link contains the video (Screencast 2019-11-24 10:43:49.mp4) and frames_191124.pdf.
rosnode list produced this...
/base_link_to_localizer
/joint_state_publisher
/play_1574609981197388211
/robot_state_publisher
/rosout
/runime_manager_7398_1574609949157
/rviz_1574609986881583137
Comment by Kenji Miyake on 2019-11-24:
Oh, I'm sorry, there was a mistake. When you use ndt_mapping, you don't need PointCloud because you will create it with ndt_mapping.
So, you need to check why it's not running and not found in rosnode list.
Are there any messages printed your runtime_manager's terminal when you activate the checkbox of ndt_mapping?
Comment by Kenji Miyake on 2019-11-24:
By the way, you can publish PointCloud just by selecting the PointCloud file, which is included in sample_moriyama_data.tar.gz, in Map tab.
To check published correctly, run rostopic echo /poits_map.
Comment by Kenji Miyake on 2019-11-24:
@avdev I've checked your video, thank you very much for taking it!
I found there was an error message RLException: [ndt_mapping]... at around 3:30.
It's probably because ndt_mapping.launch was not found in your built files.
Can you roscd lidar_localizer, and is there ~/autoware.ai/install/.../lidar_localizer/launch/ndt_mapping.launch?
Could you let me know the result of these commands?
sudo updatedb
locate ndt_mapping.launch

Comment by avdev on 2019-11-24:
I went to map tab and loaded 1 of the many .pcd files in the /.autoware/data/map/pointcloud_map/bin_Laser-00169_-00868.pcd
points did not appear in RViz
$ rostopic echo /points_map
WARNING: no messages received and simulated time is active.
Is /clock being published?
$ roscd lidar_localizer
roscd: No such package/stack 'lidar_localizer'
The only location of the files is in home/autoware.ai/src/autoware/core_perception/lidar_localizer/launch/ndt.mapping.launch
$ sudo updatedb
$ locate ndt_mapping.launch
/home/todd/autoware.ai/src/autoware/core_perception/lidar_localizer/launch/approximate_ndt_mapping.launch
/home/todd/autoware.ai/src/autoware/core_perception/lidar_localizer/launch/ndt_mapping.launch
$ sudo updatedb locate ndt_mapping_launch
updatedb: unexpected operand on command line
Comment by Kenji Miyake on 2019-11-24:
Sorry for the confusion. These are two commands.
$ sudo updatedb # Updateting index, actually not necessary, but just to be sure
$ locate ndt_mapping.launch # List the paths of files named ndt_mapping.launch
-> autoware.ai/install/lidar_localizer/share/lidar_localizer/launch/ndt_mapping.launch
However, it became non-necessary now, because I can guess your status from other results.
Also, seeing your roscd result, you didn't build Autoware.AI correctly.
Please try these commands and check if built correctly. (stderr output is okay)
$ cd ~/autoware.ai
$ colcon build --cmake-args -DCMAKE_BUILD_TYPE=Release
... long build messages
Summary: 164 packages finished [8min 51s]
49 packages had stderr output: ...

Comment by Kenji Miyake on 2019-11-24:
If you can't build, please check the dependencies are installed.
$ cd ~/autoware.ai
$ rosdep install -y --from-paths src --ignore-src --rosdistro $ROS_DISTRO
#All required rosdeps installed successfully

Comment by avdev on 2019-11-25:
Thanks Kenji.  I am new to Ubuntu and new to Autoware.
Comment by avdev on 2019-11-25:
Tried to build autoware 3 more times and the third was successful. Here are the videos but the demo still does not show the map. They are the 2 screencasts with the date 11-25.
https://drive.google.com/open?id=1fkE1XuuLg_w_SQFdljGpYLVUIDAYQaJJ
Comment by Kenji Miyake on 2019-11-25:
Please try this, which clears the cache of runtime_manager:
cd ~/autoware.ai
rm -rf ./install/runtime_manager
colcon build --cmake-args -DCMAKE_BUILD_TYPE=Release

Also, could you give me additional information to check your build environment?
$ gcc -v
...
gcc version 7.4.0 (Ubuntu 7.4.0-1ubuntu1~18.04.1) 
$ cmake --version
cmake version 3.10.2
CMake suite maintained and supported by Kitware (kitware.com/cmake).

Comment by avdev on 2019-12-04:
gcc version 7.4.0 (Ubuntu 7.4.0-1ubuntu1~18.04.1)
cmake version 3.10.2
Comment by avdev on 2019-12-04:
Built it with colcon 1x but it had errors.  Built it a 2nd time with the same command and only got this warning.
Starting >>> state_machine_lib
[7.064s] WARNING:colcon.colcon_cmake.task.cmake.build:Could not run installation step for package 'ndt_gpu' because it has no 'install' target
But the demo worked!!!
https://drive.google.com/open?id=11egzNfX_U-GxqgBgqvwsHMKmwyIKShT_
Screencast 2019-12-04 19:30:25.mp4
Now to learn how to use Rviz & Autoware.
Thanks for your help Kenji.

A:

I've recorded my operation and uploaded it to here.
What I did are:

Download files from here
Setup Autoware according to this page

If you are using ROS Melodic, I recommend using master version instead of v1.12, or please wait v1.13 which will be released soon

Launch runtime_manager
Play and pause .bag file
Launch tf of velodyne and map

It seemed ndt_mapping requires velodyne-tf BEFORE ndt_mapping

Launch ndt_mapping
Launch Rviz
Cancel the pause of .bag file
Velodyne's points can be seen in Rviz

Originally posted by Kenji Miyake with karma: 307 on 2019-11-25
This answer was ACCEPTED on the original site
Post score: 0

Original comments
Comment by scarlet191101 on 2019-12-03:
Thank you,Kenji Miyake.
I have been able to execute it a while ago, and I'm sorry to respond to it until now.
First, I started testing from the bag file.
Encountered rviz crashes, so I changed to a computer to test.
Now it can be successfully executed, and also successfully executed with its own bag file.
I've recorded my operation and uploaded it to here

