Q:

openni_launch not working in fuerte + ubuntu precise 12.04

EDIT 4: I tried launching the driver on a fresh install of fuerte on a fresh install of precise, following all ros install instructions to the letter.  Still get the same error. And I tried this on two different machines.
I've tried different versions of openni since they just updated the unstable branch with lots of bug fixes, but I couldn't get it to work.  The latest stable branch and the last stable branch before that didn't work, either.  They either get rid of the assertion error then don't recognize the device or they don't install at all. Reinstalling the openni-dev prebuilt package brings back the assertion error.
So, @ajc made a good suggestion that something gets changed somewhere since it starts the first time but stops working subsequent times.  I'm thinking in a config file, but I tried deleting the two ros config files in /opt/ros/fuerte/stacks/openni_camera/cfg and it still complained the same way.  I'd try changing some of the openni config files, but messing with the different versions of openni made some duplicate directories on my machine, and I don't quite know what's what. Somebody might try playing with the files in /etc/openni or /etc/ni (I'm not sure which you'll have, but FWIW, rosmake uses */openni directories when I build openni_camera on my computer).
It also appears I gave some bad intel before. This, this, and this all say the assertion error means that a boost pointer was not initialized somewhere (rather than the error being a header file conflict).
So I'm wondering if this might be a bug in the code rather something we're doing wrong with dependencies or installation. I can't verify this, as I'm unsure how to use nodelets with gdb.  If this does warrant a bug report, should it be to ros or openni?
EDIT 3: The problem definitely has something to do with openni. The xn namespace that the error involves in an openni namespace. I finally got images published (!) but only for two runs just like @Martin Peris. Here's the details:
Openni is now a system dependency in fuerte, so I figured I'd reinstall it from the version on their website. (If you do that, note that mono was not optional for me as it says in the readme.)
After installing openni and running openni.launch, I didn't get any fatal errors, (the only errors were that a service was already advertised) but the kinect wasn't being recognized by the driver. It just kept spitting out
No devices connected.... waiting for devices to be connected
lsusb showed the kinect fine.
So according to somebody on this thread I reinstalled openni-dev and libusb-1.0-0-dev. The next time I ran the driver, it worked and showed the depth image in rviz! However, I couldn't switch to a color image.
So I restarted the driver, and the color showed up in rviz, but depth didn't work now.  I also got an error:
Reason: openni_wrapper::OpenNIDevice::OpenNIDevice(xn::Context&, const xn::NodeInfo&, const xn::NodeInfo&, const xn::NodeInfo&, const xn::NodeInfo&) @ /tmp/buildd/ros-fuerte-openni-camera-1.8.0/debian/ros-fuerte-openni-camera/opt/ros/fuerte/stacks/openni_camera/src/openni_device.cpp @ 65 : creating image generator failed. Reason: The network connection has been closed!
I tried the troubleshooting tips suggested at the bottom of this website to no avail.
Restarting again, nothing showed in rviz and I got:
terminate called after throwing an instance of 'openni_wrapper::OpenNIException'
what():  virtual void openni_wrapper::OpenNIDevice::startDepthStream() @ /tmp/buildd/ros-fuerte-openni-camera-1.8.0/debian/ros-fuerte-openni-camera/opt/ros/fuerte/stacks/openni_camera/src/openni_device.cpp @ 257 : starting depth stream failed. Reason: Xiron OS got an event timeout!
Restarting a third time gets me the same Assertion `px != 0' failed error as before.
I still don't know about rpath issues.  I did find this thread that talks about why they're there and that there will be a change in rosbuild 2 (which doesn't seem to be coming out any time soon).
EDIT 2: Not having had to use roswtf very much, I was under the impression that it basically checked the running ROS system and the active/just-dead nodes.  However, it apparently runs other tests based on the current package in addition to those. So I ran roswtf in openni_launch and openni_camera and replaced the output above (previously, it was output from a roswtf call in my home directory).
Now I get lots of rpath issues and duplicate cpp tag warnings. The output of the graph section is the same.
Running roswtf with the --all option (not shown) looks basically the same as openni_launch, just with even more "duplicate cpp tag" errors.
So now it seems like a problem with the new fuerte FHS.  I wonder if we're not supposed to use rosmake anymore?  This REP on the FHS sure makes it seem outdated, though the tutorials (which may have yet to be rewritten post-fuerte) still use it.  I didn't see anything about not using rosmake on the migration guide, though.
EDIT: I looked more into the "Assertion `px != 0' failed" error and found this thread on stack overflow that says I might have a boost conflict.
The first rated answer says

That is not a bug. It's conflict of boost header files.

The second rated answer by Nikko says

It happens when you compile with headers from a boost version and execute with another boost version. You should check which library of boost is installed for execution, and which you use for compilation.

I do remember having to reinstall some kind of boost package when I first installed fuerte, but I don't remember exactly what I did.
So how exactly would I check which version of the boost library ROS is actually using and which version of headers it's including?
The Makefile for openni_camera just includes some other file ( $(shell rospack find mk)/cmake.mk ) and the CMakeLists.txt just says rosbuild_add_boost_directories()
ORIGINAL POST:
I've recently upgraded to precise + fuerte.  Back on natty + electric, my openni driver worked fine with my kinect, but now I'm getting errors when I try to launch it:

This code block was moved to the following github gist:
https://gist.github.com/answers-se-migration-openrobotics/05c1caef7d7631bc9161513c0d31db05

roswtf in openni_launch says:
:/opt/ros/fuerte/stacks/openni_launch/launch$ roswtf openni.launch 
Loaded plugin tf.tfwtf
[rospack] Warning: ignoring duplicate cpp tag in export block
[rospack] Warning: ignoring duplicate cpp tag in export block
[rospack] Warning: ignoring duplicate cpp tag in export block
[rospack] Warning: ignoring duplicate cpp tag in export block
[rospack] Warning: ignoring duplicate cpp tag in export block
[rospack] Warning: ignoring duplicate cpp tag in export block
================================================================================
Static checks summary:

Found 1 warning(s).
Warnings are things that may be just fine, but are sometimes at fault

WARNING The following packages have msg/srv-related cflags exports that are no longer necessary
    
        :
 * dynamic_reconfigure: -I${prefix}/msg/cpp -I${prefix}/srv/cpp

Found 1 error(s).

ERROR The following packages have rpath issues in manifest.xml:
 * openni_launch: found flag "-L/opt/ros/fuerte/lib", but no matching "-Wl,-rpath,/opt/ros/fuerte/lib"
 * rosconsole: found flag "-L/opt/ros/fuerte/lib", but no matching "-Wl,-rpath,/opt/ros/fuerte/lib"
 * stereo_msgs: found flag "-L/opt/ros/fuerte/lib", but no matching "-Wl,-rpath,/opt/ros/fuerte/lib"
 * nodelet_topic_tools: found flag "-L/opt/ros/fuerte/lib", but no matching "-Wl,-rpath,/opt/ros/fuerte/lib"
 * depth_image_proc: found flag "-L/opt/ros/fuerte/lib", but no matching "-Wl,-rpath,/opt/ros/fuerte/lib"
 * pcl_ros: found flag "-L/opt/ros/fuerte/lib", but no matching "-Wl,-rpath,/opt/ros/fuerte/lib"
 * image_proc: found flag "-L/opt/ros/fuerte/lib", but no matching "-Wl,-rpath,/opt/ros/fuerte/lib"
 * roscpp: found flag "-L/opt/ros/fuerte/lib", but no matching "-Wl,-rpath,/opt/ros/fuerte/lib"
 * roslib: found flag "-L/opt/ros/fuerte/lib", but no matching "-Wl,-rpath,/opt/ros/fuerte/lib"
 * rostest: found flag "-L/opt/ros/fuerte/lib", but no matching "-Wl,-rpath,/opt/ros/fuerte/lib"
 * pcl: found flag "-L/opt/ros/fuerte/lib", but no matching "-Wl,-rpath,/opt/ros/fuerte/lib"
 * camera_calibration_parsers: found flag "-L/opt/ros/fuerte/lib", but no matching "-Wl,-rpath,/opt/ros/fuerte/lib"
 * tf: found flag "-L/opt/ros/fuerte/lib", but no matching "-Wl,-rpath,/opt/ros/fuerte/lib"
 * nodelet: found flag "-L/opt/ros/fuerte/lib", but no matching "-Wl,-rpath,/opt/ros/fuerte/lib"
 * image_geometry: found flag "-L/opt/ros/fuerte/lib", but no matching "-Wl,-rpath,/opt/ros/fuerte/lib"
 * message_filters: found flag "-L/opt/ros/fuerte/lib", but no matching "-Wl,-rpath,/opt/ros/fuerte/lib"
 * sensor_msgs: found flag "-L/opt/ros/fuerte/lib", but no matching "-Wl,-rpath,/opt/ros/fuerte/lib"
 * std_msgs: found flag "-L/opt/ros/fuerte/lib", but no matching "-Wl,-rpath,/opt/ros/fuerte/lib"
 * image_transport: found flag "-L/opt/ros/fuerte/lib", but no matching "-Wl,-rpath,/opt/ros/fuerte/lib"
 * openni_camera: found flag "-L/opt/ros/fuerte/lib", but no matching "-Wl,-rpath,/opt/ros/fuerte/lib"
 * cv_bridge: found flag "-L/opt/ros/fuerte/lib", but no matching "-Wl,-rpath,/opt/ros/fuerte/lib"
 * dynamic_reconfigure: found flag "-L/opt/ros/fuerte/lib", but no matching "-Wl,-rpath,/opt/ros/fuerte/lib"
 * bondcpp: found flag "-L/opt/ros/fuerte/lib", but no matching "-Wl,-rpath,/opt/ros/fuerte/lib"
 * pluginlib: found flag "-L/opt/ros/fuerte/lib", but no matching "-Wl,-rpath,/opt/ros/fuerte/lib"
 * camera_info_manager: found flag "-L/opt/ros/fuerte/lib", but no matching "-Wl,-rpath,/opt/ros/fuerte/lib"
 * geometry_msgs: found flag "-L/opt/ros/fuerte/lib", but no matching "-Wl,-rpath,/opt/ros/fuerte/lib"
 * rosbag: found flag "-L/opt/ros/fuerte/lib", but no matching "-Wl,-rpath,/opt/ros/fuerte/lib"
 * bond: found flag "-L/opt/ros/fuerte/lib", but no matching "-Wl,-rpath,/opt/ros/fuerte/lib"

================================================================================
Beginning tests of your ROS graph. These may take awhile...
analyzing graph...
... done analyzing graph
running graph rules...
ERROR: connection refused to [http://vision:35939/]
... done running graph rules
running tf checks, this will take a second...
... tf checks complete

Online checks summary:

Found 1 warning(s).
Warnings are things that may be just fine, but are sometimes at fault

WARNING These nodes have died:
 * camera_nodelet_manager-1
 * camera/depth_registered/metric-14
 * camera/points_xyzrgb_depth_rgb-15
 * camera/depth/metric-9
 * camera/depth_registered/rectify_depth-12
 * camera/rgb/rectify_color-5
 * camera/ir/rectify_ir-6
 * camera/depth/rectify_depth-7
 * camera/depth/metric_rect-8
 * camera/depth/points-10
 * camera/register_depth_rgb-11
 * camera/disparity_depth_registered-17
 * camera/depth_registered/metric_rect-13
 * camera/disparity_depth-16

Found 11 error(s).

ERROR Communication with [/rosout] raised an error: 
ERROR Communication with [/camera/rgb/rectify_mono] raised an error: 
ERROR Communication with [/camera_base_link1] raised an error: 
ERROR Communication with [/camera_base_link2] raised an error: 
ERROR Communication with [/camera_base_link3] raised an error: 
ERROR Communication with [/camera/driver] raised an error: 
ERROR Communication with [/camera_nodelet_manager] raised an error: 
ERROR Communication with [/camera_base_link] raised an error: 
ERROR Could not contact the following nodes:
 * /camera_nodelet_manager

ERROR The following nodes should be connected but aren't:
 * /camera/driver->/rosout (/rosout)
 * /camera_base_link3->/rosout (/rosout)
 * /camera_base_link->/rosout (/rosout)
 * /camera_base_link2->/rosout (/rosout)
 * /camera_base_link1->/rosout (/rosout)
 * /camera_nodelet_manager->/rosout (/rosout)
 * /camera/rgb/rectify_mono->/rosout (/rosout)

ERROR Errors connecting to the following services:
 * service [/camera/rgb/image_rect/compressed/set_parameters] appears to be malfunctioning: Unable to communicate with service [/camera/rgb/image_rect/compressed/set_parameters], address [rosrpc://vision:52240]
 * service [/camera_nodelet_manager/load_nodelet] appears to be malfunctioning: Unable to communicate with service [/camera_nodelet_manager/load_nodelet], address [rosrpc://vision:52240]
 * service [/camera_nodelet_manager/list] appears to be malfunctioning: Unable to communicate with service [/camera_nodelet_manager/list], address [rosrpc://vision:52240]
 * service [/camera_nodelet_manager/get_loggers] appears to be malfunctioning: Unable to communicate with service [/camera_nodelet_manager/get_loggers], address [rosrpc://vision:52240]
 * service [/camera/rgb/image_rect_color/compressed/set_parameters] appears to be malfunctioning: Unable to communicate with service [/camera/rgb/image_rect_color/compressed/set_parameters], address [rosrpc://vision:52240]
 * service [/camera/rgb/image_rect/theora/set_parameters] appears to be malfunctioning: Unable to communicate with service [/camera/rgb/image_rect/theora/set_parameters], address [rosrpc://vision:52240]
 * service [/camera/rgb/debayer/set_parameters] appears to be malfunctioning: Unable to communicate with service [/camera/rgb/debayer/set_parameters], address [rosrpc://vision:52240]
 * service [/camera/rgb/image_mono/compressed/set_parameters] appears to be malfunctioning: Unable to communicate with service [/camera/rgb/image_mono/compressed/set_parameters], address [rosrpc://vision:52240]
 * service [/camera/rgb/rectify_color/set_parameters] appears to be malfunctioning: Unable to communicate with service [/camera/rgb/rectify_color/set_parameters], address [rosrpc://vision:52240]
 * service [/camera/rgb/image_color/compressed/set_parameters] appears to be malfunctioning: Unable to communicate with service [/camera/rgb/image_color/compressed/set_parameters], address [rosrpc://vision:52240]
 * service [/camera/rgb/image_color/theora/set_parameters] appears to be malfunctioning: Unable to communicate with service [/camera/rgb/image_color/theora/set_parameters], address [rosrpc://vision:52240]
 * service [/camera_nodelet_manager/set_logger_level] appears to be malfunctioning: Unable to communicate with service [/camera_nodelet_manager/set_logger_level], address [rosrpc://vision:52240]
 * service [/camera_nodelet_manager/unload_nodelet] appears to be malfunctioning: Unable to communicate with service [/camera_nodelet_manager/unload_nodelet], address [rosrpc://vision:52240]
 * service [/camera/rgb/rectify_mono/set_parameters] appears to be malfunctioning: Unable to communicate with service [/camera/rgb/rectify_mono/set_parameters], address [rosrpc://vision:52240]
 * service [/camera/rgb/image_mono/theora/set_parameters] appears to be malfunctioning: Unable to communicate with service [/camera/rgb/image_mono/theora/set_parameters], address [rosrpc://vision:52240]
roswtf in openni_camera says:
/opt/ros/fuerte/stacks/openni_camera$ roswtf
Loaded plugin tf.tfwtf
Package: openni_camera
================================================================================
Static checks summary:

Found 1 warning(s).
Warnings are things that may be just fine, but are sometimes at fault

WARNING The following packages have msg/srv-related cflags exports that are no longer necessary
    
        :
 * dynamic_reconfigure: -I${prefix}/msg/cpp -I${prefix}/srv/cpp

Found 1 error(s).

ERROR The following packages have rpath issues in manifest.xml:
 * openni_camera: found flag "-L/opt/ros/fuerte/lib", but no matching "-Wl,-rpath,/opt/ros/fuerte/lib"
 * dynamic_reconfigure: found flag "-L/opt/ros/fuerte/lib", but no matching "-Wl,-rpath,/opt/ros/fuerte/lib"
 * rosconsole: found flag "-L/opt/ros/fuerte/lib", but no matching "-Wl,-rpath,/opt/ros/fuerte/lib"
 * camera_info_manager: found flag "-L/opt/ros/fuerte/lib", but no matching "-Wl,-rpath,/opt/ros/fuerte/lib"
 * roscpp: found flag "-L/opt/ros/fuerte/lib", but no matching "-Wl,-rpath,/opt/ros/fuerte/lib"
 * message_filters: found flag "-L/opt/ros/fuerte/lib", but no matching "-Wl,-rpath,/opt/ros/fuerte/lib"
 * pluginlib: found flag "-L/opt/ros/fuerte/lib", but no matching "-Wl,-rpath,/opt/ros/fuerte/lib"
 * roslib: found flag "-L/opt/ros/fuerte/lib", but no matching "-Wl,-rpath,/opt/ros/fuerte/lib"
 * sensor_msgs: found flag "-L/opt/ros/fuerte/lib", but no matching "-Wl,-rpath,/opt/ros/fuerte/lib"
 * image_transport: found flag "-L/opt/ros/fuerte/lib", but no matching "-Wl,-rpath,/opt/ros/fuerte/lib"
 * rostest: found flag "-L/opt/ros/fuerte/lib", but no matching "-Wl,-rpath,/opt/ros/fuerte/lib"
 * camera_calibration_parsers: found flag "-L/opt/ros/fuerte/lib", but no matching "-Wl,-rpath,/opt/ros/fuerte/lib"
 * bond: found flag "-L/opt/ros/fuerte/lib", but no matching "-Wl,-rpath,/opt/ros/fuerte/lib"
 * nodelet: found flag "-L/opt/ros/fuerte/lib", but no matching "-Wl,-rpath,/opt/ros/fuerte/lib"
 * bondcpp: found flag "-L/opt/ros/fuerte/lib", but no matching "-Wl,-rpath,/opt/ros/fuerte/lib"

================================================================================
Beginning tests of your ROS graph. These may take awhile...
analyzing graph...
Traceback (most recent call last):
  File "/opt/ros/fuerte/lib/python2.7/dist-packages/ros_comm-1.8.7-py2.7.egg/roswtf/__init__.py", line 200, in _roswtf_main
    wtf_check_graph(ctx, names=names)
  File "/opt/ros/fuerte/lib/python2.7/dist-packages/ros_comm-1.8.7-py2.7.egg/roswtf/graph.py", line 376, in wtf_check_graph
    _compute_online_context(ctx)
  File "/opt/ros/fuerte/lib/python2.7/dist-packages/ros_comm-1.8.7-py2.7.egg/roswtf/graph.py", line 357, in _compute_online_context
    _compute_system_state(ctx)
  File "/opt/ros/fuerte/lib/python2.7/dist-packages/ros_comm-1.8.7-py2.7.egg/roswtf/graph.py", line 248, in _compute_system_state
    val = master.lookupNode(n)
  File "/opt/ros/fuerte/lib/python2.7/dist-packages/ros_comm-1.8.7-py2.7.egg/rosgraph/masterapi.py", line 430, in lookupNode
    return self._succeed(self.handle.lookupNode(self.caller_id, node_name))
  File "/opt/ros/fuerte/lib/python2.7/dist-packages/ros_comm-1.8.7-py2.7.egg/rosgraph/masterapi.py", line 151, in _succeed
    raise Error(msg)
MasterError: unknown node [/camera/disparity_depth_registered]
unknown node [/camera/disparity_depth_registered]

Aborting checks, partial results summary:

No errors or warnings

The strange thing is that /home/vision/.ros/log/742fb3d6-99eb-11e1-b3b9-68a3c4ab872b/camera_nodelet_manager-1.log does not exist. All the other log files are there, though.  Also, running test_launch.py in openni_camera does not work either.
I have a feeling this is a problem with the camera_nodelet_manager, but I don't know how to test it, and I couldn't find any other relevant threads.  Does anyone know how to fix this? Or perhaps it would help me to know: what does the error about the assertion failing mean?
nodelet: /usr/include/boost/smart_ptr/shared_ptr.hpp:412: boost::shared_ptr::reference boost::shared_ptr::operator*() const [with T = xn::NodeInfo, boost::shared_ptr::reference = xn::NodeInfo&]: Assertion `px != 0' failed.
Thanks
Originally posted by tbh on ROS Answers with karma: 3180 on 2012-05-09
Post score: 30

A:

This is not a ROS bug, but an OpenNI / PrimeSense Sensor one (openni-dev 1.5.2.23 and ps-engine 5.1.0.41 Ubuntu packages).
The boost assertion error in openni_camera (ros-fuerte-openni-camera) was caused by an uncommented exception message.
nodelet: /usr/include/boost/smart_ptr/shared_ptr.hpp:412:
  boost::shared_ptr<T>::reference boost::shared_ptr<T>::operator*() const 
  [with T = xn::NodeInfo, boost::shared_ptr<T>::reference = xn::NodeInfo&]:
  Assertion `px != 0' failed.

There is an interesting comment in the area:
  // Suat: This is an ugly ASUS Xtion workaround.
  if (status == XN_STATUS_OK)
  {
  //THROW_OPENNI_EXCEPTION ("enumerating image generators failed. Reason: %s", xnGetStatusString (status));

Maybe it occurred all the time on ASUS Xtion, so it was removed. The problem is that the Kinect color nodes can not be initialized.
I wrote a patch, so the exception is thrown again. Try my openni_camera repo, if you want.
With my patch you get a nicer exception:
terminate called after throwing an instance of 'openni_wrapper::OpenNIException'
  what():  unsigned int openni_wrapper::OpenNIDriver::updateDeviceList() 
  @ openni_camera/src/openni_driver.cpp @ 118 : enumerating image generators failed. 
  Reason: Can't create any node of the requested type!

This sadly does not solve the issue. The workaround to kill the XnSensorServer, found in the PrimeSense Sensor Module (ps-engine). Sometimes I have to start XnSensorServer and close it, if the kill does not work.
$ killall XnSensorServer
$ XnSensorServer 
Starting sensor server...
Running...
^C
$

The fix could be applied to the launch script, so you just could restart the node. But there are also runtime errors. When I restart the client application there sometimes is no Kinect image, without an openni_camera crash.
Sometimes I get following exception during runtime:
terminate called after throwing an instance of 'openni_wrapper::OpenNIException'
  what():  virtual void openni_wrapper::OpenNIDevice::startImageStream() 
  @ openni_camera/src/openni_device.cpp @ 224 : 
  starting image stream failed. Reason: Xiron OS got an event timeout!

I was very unsatisfied with the OpenNI performance and looked into the Archlinux Packages openni-git and sensorkinect-git which worked like a charm.
They use the unstable git branch of OpenNI and avin2's branch of Sensor. He frequently merges PrimeSense's unstable branch, but he did not seem to got merged upstream. His work included things like blacklisting the gspca-kinect Linux module, which conflicts with OpenNi.
This is a overview of current OpenNI and Sensor versions. You can see that ROS Fuerte is in sync with master and Jochen Sprickerhof's PCL PPA is outdated. I also experienced the boost assertion with the PCL PPA version.
openni-dev:
pcl ppa      1.3.2.1
ros deb      1.5.2.23
git master   1.5.2.23
git unstable 1.5.4.0

ps-engine:
pcl ppa      5.0.3.3
ros deb      5.1.0.41
git master   5.1.0.41
git unstable 5.1.2.1
git avin2    5.1.2.1

I made Ubuntu packages of git unstable and git avin2 with checkinstall. I didn't experience the crash on these versions. I would like to make a PPA with these versions, but can't find the ros debian source packages (there are not in the repository) and Jochen Sprickerhof's source packages are outdated.
TL;DR
Try my deb packages of openni-dev unstable and ps-engine avin2 for Ubuntu Precise 64bit.
I would recommend a reboot after installing these because there is a kernel module blacklist and udev rules in ps-engine.

Originally posted by lubosz with karma: 206 on 2012-05-29
This answer was ACCEPTED on the original site
Post score: 19

Original comments
Comment by thebyohazard on 2012-06-06:
So I applied your patch and added code to print out the EnumerationErrors given by the enumerateProductionTrees function.  It tells me a bit more info in case it helps someone: Got a timeout while waiting for a network command to complete! failed to enumerate: Image: PrimeSense/SensorV2/5.1.0.41
Comment by phil0stine on 2012-08-29:
The deb's cause the new error for my Asus that no devices are detected ala kinect not detected
Comment by kleinash on 2012-10-16:
Thanks - that works for me - but it still doesnt sort out the warnings encountered to correctly set up the yaml files (I will have to look further in to this) and there are times when I still have to kill all and reboot - not the most elegant of solutions hoping OpenNi sorts it out for Fuerte

