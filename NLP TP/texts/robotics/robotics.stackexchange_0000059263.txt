Q:

Stop Rosbag subprocess

I am able  to start up a rosbag subprocess using this setup. However, I am unable to kill the rosbag from within the python code. I have tried the methods suggested in http://answers.ros.org/question/10714/start-and-stop-rosbag-within-a-python-script/ and various methods suggested on stackoverflow yet to no avail.
Can anyone offer a solution?
    import rospy
    import rosbag
    import subprocess
    import time
    import os
    import signal
    from std_msgs.msg import Int32, String
    
    def callback(data):
    #   rospy.loginfo(rospy.get_caller_id()+"I heard %s",data.data)
        if data.data == "Start Recording":
            rospy.loginfo(rospy.get_caller_id()+"Start Recording!")
        
            global proc 
            proc = subprocess.Popen(["rosbag", "record", "-a","-o", "Subprocess"], preexec_fn=os.setsid)
        elif data.data == "Stop Recording":
            rospy.loginfo(rospy.get_caller_id()+"STOPPING RECORDING")
            if 'proc' in globals():
                rospy.loginfo(rospy.get_caller_id()+"Killing Rosbag")
                proc.terminate()
                #os.killpg(proc.pid, signal.SIGTERM)
                #proc.send_signal(subprocess.signal.SIGINT)
        else:
            rospy.loginfo(rospy.get_caller_id()+"NO BUENO")
    
    def listener():

        rospy.init_node('listener', anonymous=True)
    
        rospy.Subscriber("chatter", String, callback)
    

        rospy.spin()
            
    if __name__ == '__main__':
        listener()

Originally posted by rmb209 on ROS Answers with karma: 80 on 2014-05-09
Post score: 1

Original comments
Comment by tfoote on 2014-05-11:
How does it fail to kill?
Comment by rmb209 on 2014-05-15:
It just doesn't kill the rosbag at all - it carries on running.

A:

Are you sure it doesn't kill?
You need to kill it in a way that allows it to clean up its child processes. If you look at the process tree
tfoote   32651  0.1  0.0  67512 16148 pts/3    S+   16:02   0:00          |   |   |   \_ /usr/bin/python /opt/ros/hydro/bin/rosbag record -a -o Subprocess
tfoote   32654  0.3  0.0 1293848 7508 pts/3    Sl+  16:02   0:00          |   |   |       \_ /opt/ros/hydro/lib/rosbag/record --buffsize 256 --chunksize 768 -o Subprocess --all

rosbag record creates another child process which actually does the recording. If you kill the parent too hard it won't clean up its children. You should probably send a SIGINT not a SIGKILL.

Originally posted by tfoote with karma: 58457 on 2014-05-15
This answer was ACCEPTED on the original site
Post score: 2

Original comments
Comment by spmaniato on 2014-10-28:
os.killpg(proc.pid, signal.SIGINT)
worked, thanks

