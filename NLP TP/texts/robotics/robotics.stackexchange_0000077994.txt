Q:

rviz crash on macOS Sierra

Hi,
After lots of tweaks, I've finally made it to setup ROS Kinetic on my MacBook Air, with mac OS Sierra.
Everything works fine except rviz. It crashes on startup. I tried with this command:
rosrun rviz rviz -l

And the output is:
[ INFO] [1482424510.671672000]: rviz version 1.12.4
[ INFO] [1482424510.671803000]: compiled against Qt version 5.7.0
[ INFO] [1482424510.671830000]: compiled against OGRE version 1.7.4 (Cthugha)
libpng warning: iCCP: known incorrect sRGB profile
libpng warning: iCCP: known incorrect sRGB profile
[ INFO] [1482424511.705687000]: Creating resource group General
[ INFO] [1482424511.705788000]: Creating resource group Internal
[ INFO] [1482424511.705827000]: Creating resource group Autodetect
[ INFO] [1482424511.705940000]: SceneManagerFactory for type 'DefaultSceneManager' registered.
[ INFO] [1482424511.706240000]: Registering ResourceManager for type Material
[ INFO] [1482424511.706289000]: Registering ResourceManager for type Mesh
[ INFO] [1482424511.706321000]: Registering ResourceManager for type Skeleton
[ INFO] [1482424511.706382000]: MovableObjectFactory for type 'ParticleSystem' registered.
[ INFO] [1482424511.706445000]: OverlayElementFactory for type Panel registered.
[ INFO] [1482424511.706476000]: OverlayElementFactory for type BorderPanel registered.
[ INFO] [1482424511.706510000]: OverlayElementFactory for type TextArea registered.
[ INFO] [1482424511.706549000]: Registering ResourceManager for type Font
[ INFO] [1482424511.706587000]: ArchiveFactory for archive type FileSystem registered.
[ INFO] [1482424511.706612000]: ArchiveFactory for archive type Zip registered.
[ INFO] [1482424511.706637000]: DDS codec registering
[ INFO] [1482424511.706691000]: FreeImage version: 3.17.0
[ INFO] [1482424511.706724000]: This program uses FreeImage, a free, open source image library supporting all common bitmap formats. See http://freeimage.sourceforge.net for details
[ INFO] [1482424511.706908000]: Supported formats: bmp,ico,jpg,jif,jpeg,jpe,jng,koa,iff,lbm,mng,pbm,pbm,pcd,pcx,pgm,pgm,png,ppm,ppm,ras,tga,targa,tif,tiff,wap,wbmp,wbm,psd,cut,xbm,xpm,gif,hdr,g3,sgi,rgb,rgba,bw,exr,j2k,j2c,jp2,pfm,pct,pict,pic,3fr,arw,bay,bmq,cap,cine,cr2,crw,cs1,dc2,dcr,drf,dsc,dng,erf,fff,ia,iiq,k25,kc2,kdc,mdc,mef,mos,mrw,nef,nrw,orf,pef,ptx,pxn,qtk,raf,raw,rdc,rw2,rwl,rwz,sr2,srf,srw,sti,x3f,webp,jxr,wdp,hdp
[ INFO] [1482424511.706943000]: Registering ResourceManager for type HighLevelGpuProgram
[ INFO] [1482424511.707169000]: Registering ResourceManager for type Compositor
[ INFO] [1482424511.707464000]: MovableObjectFactory for type 'Entity' registered.
[ INFO] [1482424511.707513000]: MovableObjectFactory for type 'Light' registered.
[ INFO] [1482424511.707546000]: MovableObjectFactory for type 'BillboardSet' registered.
[ INFO] [1482424511.707575000]: MovableObjectFactory for type 'ManualObject' registered.
[ INFO] [1482424511.707607000]: MovableObjectFactory for type 'BillboardChain' registered.
[ INFO] [1482424511.707636000]: MovableObjectFactory for type 'RibbonTrail' registered.
[ INFO] [1482424511.707859000]: *-*-* OGRE Initialising
[ INFO] [1482424511.707901000]: *-*-* Version 1.7.4 (Cthugha)
[ INFO] [1482424511.707944000]: Loading library /usr/local/Cellar/ogre/1.7.4/lib/libRenderSystem_GL
[ INFO] [1482424511.715310000]: Installing plugin: GL RenderSystem
[ INFO] [1482424511.715470000]: OpenGL Rendering Subsystem created.
[ INFO] [1482424511.715731000]: Plugin successfully installed
[ INFO] [1482424511.715784000]: Loading library /usr/local/Cellar/ogre/1.7.4/lib/libPlugin_OctreeSceneManager
[ INFO] [1482424511.722139000]: Installing plugin: Octree & Terrain Scene Manager
[ INFO] [1482424511.722224000]: Plugin successfully installed
[ INFO] [1482424511.722266000]: Loading library /usr/local/Cellar/ogre/1.7.4/lib/libPlugin_ParticleFX
[ INFO] [1482424511.728896000]: Installing plugin: ParticleFX
[ INFO] [1482424511.728966000]: Particle Emitter Type 'Point' registered
[ INFO] [1482424511.729014000]: Particle Emitter Type 'Box' registered
[ INFO] [1482424511.729069000]: Particle Emitter Type 'Ellipsoid' registered
[ INFO] [1482424511.729102000]: Particle Emitter Type 'Cylinder' registered
[ INFO] [1482424511.729130000]: Particle Emitter Type 'Ring' registered
[ INFO] [1482424511.729159000]: Particle Emitter Type 'HollowEllipsoid' registered
[ INFO] [1482424511.729187000]: Particle Affector Type 'LinearForce' registered
[ INFO] [1482424511.729210000]: Particle Affector Type 'ColourFader' registered
[ INFO] [1482424511.729232000]: Particle Affector Type 'ColourFader2' registered
[ INFO] [1482424511.729269000]: Particle Affector Type 'ColourImage' registered
[ INFO] [1482424511.729292000]: Particle Affector Type 'ColourInterpolator' registered
[ INFO] [1482424511.729352000]: Particle Affector Type 'Scaler' registered
[ INFO] [1482424511.729391000]: Particle Affector Type 'Rotator' registered
[ INFO] [1482424511.729488000]: Particle Affector Type 'DirectionRandomiser' registered
[ INFO] [1482424511.729520000]: Particle Affector Type 'DeflectorPlane' registered
[ INFO] [1482424511.729550000]: Plugin successfully installed
[ INFO] [1482424511.729632000]: CPU Identifier & Features
[ INFO] [1482424511.729666000]: -------------------------
[ INFO] [1482424511.729694000]:  *   CPU ID: GenuineIntel: Intel(R) Core(TM) i5-5250U CPU @ 1.60GHz
[ INFO] [1482424511.729723000]:  *      SSE: yes
[ INFO] [1482424511.729743000]:  *     SSE2: yes
[ INFO] [1482424511.729764000]:  *     SSE3: yes
[ INFO] [1482424511.729783000]:  *      MMX: yes
[ INFO] [1482424511.729804000]:  *   MMXEXT: yes
[ INFO] [1482424511.729822000]:  *    3DNOW: no
[ INFO] [1482424511.729843000]:  * 3DNOWEXT: no
[ INFO] [1482424511.729865000]:  *     CMOV: yes
[ INFO] [1482424511.729882000]:  *      TSC: yes
[ INFO] [1482424511.729903000]:  *      FPU: yes
[ INFO] [1482424511.729926000]:  *      PRO: yes
[ INFO] [1482424511.729944000]:  *       HT: no
[ INFO] [1482424511.729962000]: -------------------------
[ INFO] [1482424511.730001000]: ********************************************
***  Starting Mac OS X OpenGL Subsystem  ***
********************************************
[ INFO] [1482424511.730131000]: GLRenderSystem::_createRenderWindow "OgreWindow(0)", 1x1 windowed  miscParams: FSAA=4 externalGLControl= externalWindowHandle=0 macAPI=carbon

Seems like there's something wrong with the OpenGL library provide by the system? Probably related to ogre rendering. I installed ogre version 1.7.4 via brew, both binary install and source compile have been tested, both with no luck.
The system generated a report after rviz crashes. I posted the complete report on Gist here
And I have tried to export OGRE_RTT_MODE=FBO and also 'PBuffer', 'Copy' values, no difference.
Can any one help? Thank you so much.

Edit: @William
osx_ogre_1_9 relies on qt4, and I have tried my best to migrate it to qt5. However, the compiling process failed at the sip command:
sip: QMainWindow has not been defined
Traceback (most recent call last):
  File "/Users/victor/Repo/ros/ros_kinetic/install_isolated/share/python_qt_binding/cmake/sip_configure.py", line 76, in <module>
    subprocess.check_call(cmd)
  File "/usr/local/Cellar/python/2.7.12_2/Frameworks/Python.framework/Versions/2.7/lib/python2.7/subprocess.py", line 541, in check_call
    raise CalledProcessError(retcode, cmd)
subprocess.CalledProcessError: Command '['/usr/local/Cellar/sip/4.18.1/bin/sip', '-c', '/Users/victor/Repo/ros/ros_kinetic/devel_isolated/rviz/bin/sip/rviz_sip', '-b', '/Users/victor/Repo/ros/ros_kinetic/devel_isolated/rviz/bin/sip/rviz_sip/pyqtscripting.sbf', '-I', '/usr/local/share/sip/Qt5', '-w', '-x', 'VendorID', '-t', 'WS_MACX', '-t', 'Qt_5_7_0', '-x', 'Py_v3', 'rviz.sip']' returned non-zero exit status 1
make[2]: *** [/Users/victor/Repo/ros/ros_kinetic/devel_isolated/rviz/bin/sip/rviz_sip/Makefile] Error 1
make[1]: *** [src/python_bindings/sip/CMakeFiles/librviz_sip.dir/all] Error 2
make[1]: *** Waiting for unfinished jobs....

I'm not very familiar with sip, so I can't tell what to do next

Originally posted by ZOU Lu on ROS Answers with karma: 143 on 2016-12-22
Post score: 1

Original comments
Comment by ZOU Lu on 2016-12-28:
Still waiting for helps~~~
Comment by gvdhoorn on 2016-12-28:
It may very well be that you are running into an issue that not many / no one else is running into to. That could explain the lack of response.
Comment by gvdhoorn on 2016-12-30:
@ZOU Lu: I've moved your answer to your OP, as it was not really an answer, but an update.
Comment by Gorbag on 2017-04-29:
It would be great if you posted your tweaks, I'm still struggling to get kinetic installed under Sierra.
Comment by ZOU Lu on 2017-04-30:
@Gorbag I actually fixed almost every issues, including rviz. But I found it's still inconvenient to run ROS on macOS, such as manually compile all packages from src. I recommend you to try install Ubuntu as a virtual machine on your Mac. Using a light weight WM like i3wm, it should run fast.
Comment by ZOU Lu on 2017-04-30:
I don't remember how to tweak them all, some tweaks were ugly, so the best way would be run a virtual machine. Developing under Ubuntu is like a breeze.
I don't like Ubuntu actually, but it do improved my productivity.
By the way, QtCreator is another Swiss Knife you should give a try.

A:

The problem is that rviz erroneously sets macAPI to carbon although it is cocoa - qt5 (5.7.1) is missing the define QT_MAC_USE_COCOA. After editing rviz/src/rviz/ogre_helpers/render_system.cpp, I got rviz to start.
I replaced
// Set the macAPI for Ogre based on the Qt implementation
#ifdef QT_MAC_USE_COCOA
  params["macAPI"] = "cocoa";
  params["macAPICocoaUseNSView"] = "true";
#else
  params["macAPI"] = "carbon";
#endif

by
// Set the macAPI for Ogre based on the Qt implementation
  params["macAPI"] = QT_QPA_DEFAULT_PLATFORM_NAME;
  params["macAPICocoaUseNSView"] = "true";

I am using ogre 1.7.4 by the way.

Originally posted by dischu with karma: 56 on 2017-01-14
This answer was ACCEPTED on the original site
Post score: 0

Original comments
Comment by ahendrix on 2017-01-14:
I believe there is logic to detect and set this flag in the CMakeLists, so you can probably update that logic instead of modifying the source code.
Comment by dischu on 2017-01-15:
In case you are using the ros-install-osx install script, you can just add -DCMAKE_CXX_FLAGS="${CMAKE_CXX_FLAGS} -DQT_MAC_USE_COCOA" to the catkin config call. This is brute force, but prevents any modification inside the source tree.

