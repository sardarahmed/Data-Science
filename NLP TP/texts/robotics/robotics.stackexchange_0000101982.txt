Q:

publish() to a closed topic when processing data

I am using ros to study autonomous driving. I want to develop a function:
when the handle is manually operated, let the operation of the handle be executed first, and when the handle is not operated, read the target speed calculated by the computer and travel according to the target speed.
code show as below

    #!/usr/bin/python
    # -*- coding: utf-8 -*-

    import rospy
    
    from geometry_msgs.msg import Twist
    
    from geometry_msgs.msg import TwistStamped

    from sensor_msgs.msg import Joy

    def callback2(data2):
        #pub2 = rospy.Publisher('whill/controller/cmd_vel', Twist, queue_size=100)
        r = rospy.Rate(100.0)
        rospy.loginfo(data2.axes[0])
        rospy.loginfo(data2.axes[1])
        x_joy=data2.axes[0]
        y_joy=data2.axes[1]
        if x_joy == 0 and y_joy == 0:
            rospy.Subscriber("/twist_cmd", TwistStamped, callback1)
            r.sleep()

    def callback1(data1):
        pub1 = rospy.Publisher('whill/controller/cmd_vel', Twist, queue_size=100)
        r = rospy.Rate(100.0)
        rospy.loginfo(data1.twist.linear.x)
        rospy.loginfo(data1.twist.angular.z)
        twist = Twist()
        twist.linear.x = 0
        twist.angular.z = 0
        twist.linear.x = abs(data1.twist.linear.x)
        twist.angular.z = data1.twist.angular.z
        if twist.linear.x != 0 or twist.angular.z != 0:
            pub1.publish(twist)
           r.sleep()
    
    def main():
        rospy.init_node('pubsub0', anonymous=True)
        rospy.Subscriber("/whill/states/joy", Joy, callback2)
        rospy.spin()
    
    if __name__ == '__main__':
        main()
    
    ```

Where **data2.axes[0]** and **data2.axes[1]** respectively represent the position coordinates of the joystick. When the joystick is not in operation, the coordinate value is 0.

After executing the above code, I get the following error

![Snipaste_2022-06-20_17-19-54](https://s2.loli.net/2022/06/21/AfG9Mjidrz5ocvQ.png)

At this time, the vehicle moves forward according to the target speed calculated by the computer, but at this time, there is no response when touching the joystick of the handle.

I am a newbie in ros learning. Can anyone tell me the meaning of this bug and how to modify the code?

thanks in advance

---

[Originally posted](https://answers.ros.org/question/402623/publish()-to-a-closed-topic-when-processing-data/) by [yzk123456](https://answers.ros.org/users/108731/yzk123456/) on ROS Answers with karma: 3 on 2022-06-21

Post score: 0

---

### Original comments

**Comment by [Mike Scheutzow](https://answers.ros.org/users/75154/mike-scheutzow/) on 2022-06-21**:\
Please do not use screenshots of text. They are not searchable, and are difficult to read. Instead, copy/paste the text into your description, and format it with the 101010 button.

**Comment by [yzk123456](https://answers.ros.org/users/108731/yzk123456/) on 2022-06-23**:\
Thanks for comment 
Here is the error text

    [ERROR] [ 1655712212.090416] : bad callback : <function cakllback at 0x7f285ebcde50>
    Traceback (most recent call last):
        File "opt/ros/melodic/lib/python2.7/dist-packages/rospy/topics.py" , line 750, in _invoke_callback cb(msg)
        File "opt/ros/melodic/lib/python2.7/dist-packages/rospy/topics.py" , line 882, in publish self.impl.publish(data) 
        File "opt/ros/melodic/lib/python2.7/dist-packages/rospy/topics.py" , line 1041,in publish raise ROSException("publish() to a closed topic")
    ROSException : publish() to a closed topic

A:

You can not create a publisher object using rospy.Publisher(), and then immediately use that object. If your ros system includes a wifi network, it can take 100's of milliseconds before the publisher is ready to use.
You should create all your publishers and subscribers in your main(), after the rospy.init_node(). If you need to use the publisher object inside a subscriber callback, then assign it to a global variable.
Also, it is bad practice to sleep() inside a subscriber callback.

Originally posted by Mike Scheutzow with karma: 4903 on 2022-06-24
This answer was ACCEPTED on the original site
Post score: 0

