Q:

Nav2 building from source in docker

I'm trying to make a Dockerfile with nav2 build process, but I'm facing a problem:
FROM dustynv/ros:humble-ros-base-l4t-r32.7.1

RUN mkdir -p /root/nav2_ws/src
WORKDIR /root/nav2_ws

ENV ROS_PACKAGE_PATH=/opt/ros/humble/install

# ROS fundamentals
RUN apt-mark hold '*opencv*' \
    && apt-get update \
    && apt autoremove -y \
    && rosinstall_generator --deps --exclude RPP --rosdistro humble navigation2 > ros2.humble.nav2.rosinstall \
    && vcs import src/ < ros2.humble.nav2.rosinstall \
    # &&  sudo rosdep fix-permissions \
    &&  rosdep update

RUN rosdep install -y --ignore-src --from-paths src --rosdistro humble --skip-keys "xsimd" --skip-keys "ignition-cmake2" --skip-keys "ignition-math6"

The last RUN command returns several errors:
ERROR: the following packages/stacks could not have their rosdep keys resolved

in the image build process.
But, if I comment out that RUN command, build the image and run it, then inside the container I can run that command without errors (all dependencies are solved and installed.)
What am I missing?
docker build -t nav2_docker -f Dockerfile .

and
docker run -it --rm --network bridge nav2_docker:latest

A:

You need to source your Humble overlay before running rosdep. When you build the image without that last line and then run it, you can see that the sourcing happens during the entrypoint.
Also remember that the default shell in docker is not bash. You can switch to bash by putting the following line in your dockerfile SHELL ["/bin/bash", "-c"], but this will run all commands after this line with bash.
So the last line of your dockerfile can become 3 lines:
SHELL ["/bin/bash", "-c"]
RUN source /opt/ros/humble/install/setup.bash \
    && rosdep install <rest of your options>

