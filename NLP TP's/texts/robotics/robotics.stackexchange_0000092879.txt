Q:

Error when trying to load and execute a custom nodelet

ENV: Ros Melodic on Ubuntu 18.04
Hi,
I am trying to launch my custom nodelet after building it.
after running a catkin_make without any problem and executing  roscore followed of
rosrun nodelet nodelet manager __name:=nodelet_manager

And when trying to load my nodelet by running
rosrun nodelet nodelet load quadcopter/Quadcopter nodelet_manager

I received the following error:
[ INFO] [1565186442.980560504]: Loading nodelet /quadcopter_Quadcopter of type quadcopter/Quadcopter to manager nodelet_manager with the following remappings:
[FATAL] [1565186443.003452463]: Failed to load nodelet '/quadcopter_Quadcopter` of type `quadcopter/Quadcopter` to manager `nodelet_manager'

From the terminal where the nodelet manager is running, I received this error:
[ INFO] [1565180138.705802164]: Initializing nodelet with 8 worker threads.
[ERROR] [1565180345.275768382]: Failed to load nodelet [/quadcopter_Quadcopter] of type [quadcopter/Quadcopter] even after refreshing the cache: Failed to load library /home/workspace/quadcopter/devel/lib//libnodelet_quad.so. Make sure that you are calling the PLUGINLIB_EXPORT_CLASS macro in the library code, and that names are consistent between this macro and your XML. Error string: Could not load library (Poco exception = /home/workspace/quadcopter/devel/lib//libnodelet_quad.so: undefined symbol: _ZN10quadcopter10Quadcopter2g0E)
[ERROR] [1565180345.275832676]: The error before refreshing the cache was: Failed to load library /home/workspace/quadcopter/devel/lib//libnodelet_quad.so. Make sure that you are calling the PLUGINLIB_EXPORT_CLASS macro in the library code, and that names are consistent between this macro and your XML. Error string: Could not load library (Poco exception = /home/workspace/quadcopter/devel/lib//libnodelet_quad.so: undefined symbol: _ZN10quadcopter10Quadcopter2g0E)
[ERROR] [1565180354.586223790]: Failed to load nodelet [/quadcopter] of type [quadcopter] even after refreshing the cache: According to the loaded plugin descriptions the class quadcopter with base class type nodelet::Nodelet does not exist. Declared types are  depth_image_proc/convert_metric depth_image_proc/crop_foremost depth_image_proc/disparity depth_image_proc/point_cloud_xyz depth_image_proc/point_cloud_xyz_radial depth_image_proc/point_cloud_xyzi depth_image_proc/point_cloud_xyzi_radial depth_image_proc/point_cloud_xyzrgb depth_image_proc/register image_proc/crop_decimate image_proc/crop_nonZero image_proc/crop_non_zero image_proc/debayer image_proc/rectify image_proc/resize image_publisher/image_publisher image_rotate/image_rotate image_view/disparity image_view/image nodelet_tutorial_math/Plus pcl/BAGReader pcl/BoundaryEstimation pcl/ConvexHull2D pcl/CropBox pcl/EuclideanClusterExtraction pcl/ExtractIndices pcl/ExtractPolygonalPrismData pcl/FPFHEstimation pcl/FPFHEstimationOMP pcl/MomentInvariantsEstimation pcl/MovingLeastSquares pcl/NodeletDEMUX pcl/NodeletMUX pcl/NormalEstimation pcl/NormalEstimationOMP pcl/NormalEstimationTBB pcl/PCDReader pcl/PCDWriter pcl/PFHEstimation pcl/PassThrough pcl/PointCloudConcatenateDataSynchronizer pcl/PointCloudConcatenateFieldsSynchronizer pcl/PrincipalCurvaturesEstimation pcl/ProjectInliers pcl/RadiusOutlierRemoval pcl/SACSegmentation pcl/SACSegmentationFromNormals pcl/SHOTEstimation pcl/SHOTEstimationOMP pcl/SegmentDifferences pcl/StatisticalOutlierRemoval pcl/VFHEstimation pcl/VoxelGrid quadcopter/Quadcopter stereo_image_proc/disparity stereo_image_proc/point_cloud2
[ERROR] [1565180354.586274424]: The error before refreshing the cache was: According to the loaded plugin descriptions the class quadcopter with base class type nodelet::Nodelet does not exist. Declared types are  depth_image_proc/convert_metric depth_image_proc/crop_foremost depth_image_proc/disparity depth_image_proc/point_cloud_xyz depth_image_proc/point_cloud_xyz_radial depth_image_proc/point_cloud_xyzi depth_image_proc/point_cloud_xyzi_radial depth_image_proc/point_cloud_xyzrgb depth_image_proc/register image_proc/crop_decimate image_proc/crop_nonZero image_proc/crop_non_zero image_proc/debayer image_proc/rectify image_proc/resize image_publisher/image_publisher image_rotate/image_rotate image_view/disparity image_view/image nodelet_tutorial_math/Plus pcl/BAGReader pcl/BoundaryEstimation pcl/ConvexHull2D pcl/CropBox pcl/EuclideanClusterExtraction pcl/ExtractIndices pcl/ExtractPolygonalPrismData pcl/FPFHEstimation pcl/FPFHEstimationOMP pcl/MomentInvariantsEstimation pcl/MovingLeastSquares pcl/NodeletDEMUX pcl/NodeletMUX pcl/NormalEstimation pcl/NormalEstimationOMP pcl/NormalEstimationTBB pcl/PCDReader pcl/PCDWriter pcl/PFHEstimation pcl/PassThrough pcl/PointCloudConcatenateDataSynchronizer pcl/PointCloudConcatenateFieldsSynchronizer pcl/PrincipalCurvaturesEstimation pcl/ProjectInliers pcl/RadiusOutlierRemoval pcl/SACSegmentation pcl/SACSegmentationFromNormals pcl/SHOTEstimation pcl/SHOTEstimationOMP pcl/SegmentDifferences pcl/StatisticalOutlierRemoval pcl/VFHEstimation pcl/VoxelGrid quadcopter/Quadcopter stereo_image_proc/disparity stereo_image_proc/point_cloud2
[ERROR] [1565180394.471568402]: Failed to load nodelet [/quadcopter_Quadcopter] of type [quadcopter/Quadcopter] even after refreshing the cache: Failed to load library /home/workspace/quadcopter/devel/lib//libnodelet_quad.so. Make sure that you are calling the PLUGINLIB_EXPORT_CLASS macro in the library code, and that names are consistent between this macro and your XML. Error string: Could not load library (Poco exception = /home/workspace/quadcopter/devel/lib//libnodelet_quad.so: undefined symbol: _ZN10quadcopter10Quadcopter2g0E)
[ERROR] [1565180394.471628721]: The error before refreshing the cache was: Failed to load library /home/workspace/quadcopter/devel/lib//libnodelet_quad.so. Make sure that you are calling the PLUGINLIB_EXPORT_CLASS macro in the library code, and that names are consistent between this macro and your XML. Error string: Could not load library (Poco exception = /home/workspace/quadcopter/devel/lib//libnodelet_quad.so: undefined symbol: _ZN10quadcopter10Quadcopter2g0E)

I have this particular Message:
Make sure that you are calling the PLUGINLIB_EXPORT_CLASS macro in the library code, and that names are consistent between this macro and your XML

but I have the same class name for both (see below)
Here my CMakeList and my xml files:
CMakeList.txt
cmake_minimum_required(VERSION 2.8.3)
project(quadcopter)

add_compile_options(-std=c++11)

find_package(catkin REQUIRED COMPONENTS nodelet roscpp std_msgs geometry_msgs message_generation)

add_message_files(
  FILES
  Thrust.msg
)

generate_messages(
  DEPENDENCIES
  geometry_msgs
  std_msgs
)

## Setup include directories
include_directories(${catkin_INCLUDE_DIRS})

catkin_package(
  INCLUDE_DIRS include
  LIBRARIES nodelet_quad
  CATKIN_DEPENDS nodelet roscpp std_msgs message_generation geometry_msgs
)

include_directories(
  include
  ${catkin_INCLUDE_DIRS}
)

## Create the nodelet library
add_library(nodelet_quad src/Quadcopter.cpp)
target_link_libraries(nodelet_quad ${catkin_LIBRARIES})
if(catkin_EXPORTED_LIBRARIES)
  add_dependencies(nodelet_quad ${catkin_EXPORTED_LIBRARIES})
endif()

## Mark the nodelet library for installations
install(TARGETS nodelet_quad
  ARCHIVE DESTINATION ${CATKIN_PACKAGE_LIB_DESTINATION}
  LIBRARY DESTINATION ${CATKIN_PACKAGE_LIB_DESTINATION}
  RUNTIME DESTINATION ${CATKIN_PACKAGE_BIN_DESTINATION})

## Mark other files for installation (e.g. launch and bag files, etc.)
install(FILES nodelet_quad.xml config/quadcopter_params.yaml
  DESTINATION ${CATKIN_PACKAGE_SHARE_DESTINATION})

nodelet_quad.xml
<library path="lib/libnodelet_quad">
  <class name="quadcopter/Quadcopter" type="quadcopter::Quadcopter" base_class_type="nodelet::Nodelet">
    <description> 
      Nodelet simulating quadrotor dynamics
    </description>
  </class></library>

my nodelet class:
#include <pluginlib/class_list_macros.h>
#include "quadcopter/Quadcopter.h"
namespace quadcopter
    {
    
     // Class methods ect...
    
   
    PLUGINLIB_EXPORT_CLASS(quadcopter::Quadcopter, nodelet::Nodelet)
    }

Edit:
More likely the error come from the linking:
(Poco exception = /home/workspace/quadcopter/devel/lib//libnodelet_quad.so: undefined symbol: _ZN10quadcopter10Quadcopter2g0E)  with the //  in  lib//libnodelet_quad.so.
I tried to build again, with double checking the CMakeLists with the nodelet.xml but I still end up with the same error but less wordy:
[ERROR] [1565259705.423610302]: Failed to load nodelet [/quadcopter_Quadcopter] of type [quadcopter/Quadcopter] even after refreshing t 
he cache: Failed to load library /home/workspace/quadcopter/devel/lib//libnodelet_quad.so. Make sure that you are calling the PLUGINLIB 
_EXPORT_CLASS macro in the library code, and that names are consistent between this macro and your XML. Error string: Could not load li 
brary (Poco exception = /home/workspace/quadcopter/devel/lib//libnodelet_quad.so: undefined symbol: _ZN10quadcopter10Quadcopter2g0E)    
[ERROR] [1565259705.423669605]: The error before refreshing the cache was: Failed to load library /home/workspace/quadcopter/devel/lib/ 
/libnodelet_quad.so. Make sure that you are calling the PLUGINLIB_EXPORT_CLASS macro in the library code, and that names are consistent 
 between this macro and your XML. Error string: Could not load library (Poco exception = /home/workspace/quadcopter/devel/lib//libnodel 
et_quad.so: undefined symbol: _ZN10quadcopter10Quadcopter2g0E) 

I also added pluginlib in the xml and cmakelist dependencies. When building I have:
[100%] Linking CXX shared library /home/workspace/quadcopter/devel/lib/libnodelet_quad.so      

as before, but still the same poco error.
Thank you for your time.

Originally posted by Confused Lizard on ROS Answers with karma: 51 on 2019-08-07
Post score: 0

A:

I found the issue. It was a linking library  issue as expected but it was coming from a ill defined static constexpr variable withing my nodelet class.
I diagnosed it using  c++filt _ZN10quadcopter10Quadcopter2g0E
The loading does not return this error anymore.

Originally posted by Confused Lizard with karma: 51 on 2019-08-08
This answer was ACCEPTED on the original site
Post score: 1

