Q:

rtabmap localization

Hi
I'm trying to run rtabmap in localization mode.
This is my launch file:
<launch>
<arg name="localization" value="true"/>

<arg     if="$(arg localization)" name="rtabmap_args"  default=""/>
<arg unless="$(arg localization)" name="rtabmap_args"  default="--delete_db_on_start"/>

<node pkg="tf2_ros" type="static_transform_publisher" name="camera_broadcaster" args="0.613 0.012 0.425 0.002 0.008 -0.010 1.000 base_link camera_link" />
<node pkg="tf2_ros" type="static_transform_publisher" name="footprint_broadcaster" args="0 0 0.125 0 0 0 1 base_footprint base_link" />

<param name="robot_description" textfile="$(find robot_slam)/urdf/robot.urdf" />

<node pkg="robot_slam" name="control" type="control.py" output="screen">
</node>

<!-- ROS navigation stack move_base -->
<group ns="planner">
    <remap from="point_cloud" to="/planner/planner_cloud"/>
    <remap from="map" to="/rtabmap/grid_map"/>
    <remap from="move_base_simple/goal" to="/move_base_simple/goal"/>
    
    <node pkg="move_base" type="move_base" respawn="false" name="move_base" output="screen">
        <rosparam file="$(find robot_slam)/launch/config/move_base/costmap_common.yaml" command="load" ns="global_costmap" />
        <rosparam file="$(find robot_slam)/launch/config/move_base/costmap_common.yaml" command="load" ns="local_costmap" />
        <rosparam file="$(find robot_slam)/launch/config/move_base/costmap_local.yaml" command="load" />
        <rosparam file="$(find robot_slam)/launch/config/move_base/costmap_global.yaml" command="load"/>
        <rosparam file="$(find robot_slam)/launch/config/move_base/base_local_planner.yaml" command="load" />
    </node>
</group>

<!-- encoder odometry -->
<node pkg="robot_slam" name="encoder_odometry" type="odometry.py" output="screen">
    <remap from="odom" to="/planner/odom"/>

    <param name="odom_frame_id" type="string" value="odom"/>
    <param name="robot_frame_id" type="string" value="base_footprint"/>
</node>

<group ns="rtabmap">
    <!-- RGB-D Odometry -->
    <node pkg="rtabmap_ros" type="rgbd_odometry" name="rgbd_odometry" output="log">
        <remap from="rgb/image"       to="/camera/color/image_raw"/>
        <remap from="depth/image"     to="/camera/aligned_depth_to_color/image_raw"/>
        <remap from="rgb/camera_info" to="/camera/color/camera_info"/>
        <remap from="rgbd_image"      to="rgbd_image"/>
        <remap from="odom"            to="rgbd_odom"/>
    
        <param name="frame_id"                    type="string" value="base_footprint"/>
        <param name="odom_frame_id"               type="string" value="odom"/>
        <param name="publish_tf"                  type="bool"   value="true"/>
        <param name="ground_truth_frame_id"       type="string" value=""/>
        <param name="ground_truth_base_frame_id"  type="string" value=""/>
        <param name="wait_for_transform"          type="bool"   value="true"/>
        <param name="wait_for_transform_duration" type="double" value="0.2"/>
        <param name="approx_sync"                 type="bool"   value="false"/>
        <param name="config_path"                 type="string" value=""/>
        <param name="queue_size"                  type="int"    value="10"/>
        <param name="subscribe_rgbd"              type="bool"   value="false"/>
        <param name="guess_frame_id"              type="string" value=""/>
        <param name="guess_min_translation"       type="double" value="0"/>
        <param name="guess_min_rotation"          type="double" value="0"/>

        <param name="Odom/ResetCountdown"         type="int"    value="10"/>
        <param name="Odom/Holonomic" type="bool" value="false"/>
        <param name="Vis/MaxFeatures" type="string" value="1000"/>
        <param name="Reg/Force3DoF"             type="bool" value="false"/>

        <param name="RGBD/SavedLocalizationIgnored" type="bool" value="true"/>
    </node>
    
    <node pkg="rtabmap_ros" type="rtabmap" name="rtabmap" args="$(arg rtabmap_args)" output="log">
        <param if="$(arg localization)" name="Mem/IncrementalMemory" type="string" value="false"/>
        <param if="$(arg localization)" name="Mem/InitWMWithAllNodes" type="string" value="true"/>

        <remap from="odom" to="/rtabmap/rgbd_odom"/> 
        <remap from="rgb/image" to="/camera/color/image_raw"/>
        <remap from="depth/image" to="/camera/aligned_depth_to_color/image_raw"/>
        <remap from="rgb/camera_info" to="/camera/color/camera_info"/>

        <param name="frame_id"          type="string"   value="base_footprint"/>
        <param name="odom_frame_id"     type="string"   value="odom"/>
        <param name="map_frame_id"      type="string"   value="map"/>
        <param name="subscribe_depth"   type="bool"     value="true"/>
        <param name="subscribe_scan"    type="bool"     value="false"/>
        <param name="queue_size"        type="int"      value="10"/>

        <!-- RTAB-Map's parameters -->

        <param name="RGBD/ProximityBySpace"     type="string" value="false"/>
        <param name="RGBD/AngularUpdate"        type="string" value="0.01"/>
        <param name="RGBD/LinearUpdate"         type="string" value="0.01"/>
        <param name="RGBD/OptimizeFromGraphEnd" type="string" value="false"/>
        <param name="Reg/Strategy"              type="string" value="1"/> <!-- 0=vis, 1=ICP, 2=both. 1 works best -->
        <param name="Reg/Force3DoF"             type="string" value="false"/>
        <param name="Vis/MinInliers"            type="string" value="20"/>
        <param name="Vis/InlierDistance"        type="string" value="0.05"/>
        <param name="Rtabmap/TimeThr"           type="string" value="700"/>
        <param name="Mem/RehearsalSimilarity"   type="string" value="0.45"/>
        <param name="Icp/CorrespondenceRatio"   type="string" value="0.5"/>

        <param name="Grid/MaxGroundHeight" type="double" value="0.2"/>
        <param name="Grid/MaxObstacleHeight" type="double" value="1.0"/>
        <param name="Grid/NormalsSegmentation" type="bool" value="false"/>
        <param name="Grid/RangeMax"             type="double" value="4"/>
    </node>

    <node pkg="nodelet" type="nodelet" name="voxel_grid" args="load pcl/VoxelGrid /camera/realsense2_camera_manager" output="screen">
        <remap from="~input" to="/camera/depth/color/points" />
        <remap from="~output" to="/camera/depth/color/points_downsampled" />
        <rosparam>
            filter_field_name: z
            filter_limit_min: 0.01
            filter_limit_max: 10
            filter_limit_negative: False
            leaf_size: 0.05
        </rosparam>
    </node>

    <!-- obstacle detection -->
    <node pkg="nodelet" type="nodelet" name="obstacles_detection" args="load rtabmap_ros/obstacles_detection /camera/realsense2_camera_manager" output="screen">
        <remap from="cloud" to="/camera/depth/color/points_downsampled"/>
        <remap from="obstacles" to="/planner/planner_cloud"/>

        <param name="frame_id" type="string" value="base_footprint"/>
        <param name="wait_for_transform" type="bool" value="true"/>
        <!-- should be the same as leaf_size in voxelfilter above -->
        <param name="Grid/CellSize" type="double" value="0.05"/>
        <param name="Grid/NormalsSegmentation" type="bool" value="false"/>
        <param name="Grid/MaxGroundHeight" type="double" value="0.2"/>
        <param name="Grid/MaxObstacleHeight" type="double" value="1.0"/>
        <param name="Grid/RangeMax"             type="double" value="4"/>
    </node>
</group>

When I start the launch file with a presaved database, map to odom gets published (I can see them in RVIZ) but it's wrong. It's not updated after the start. And the info topic shows high enough hypothesis values (>0.11) but there's never a loop closure.
When I move the robot around, it moves along correctly in RVIZ, but there's that offset that is not corrected, i.e. the preloaded map is useless. Do I understand correctly that the rtabmap node should detect the loop closures and send out the map to odom transform? Does that also mean that the rgbd_odom node doesn't use the map to localize?
Thanks in advance,
rembert

Originally posted by rembert on ROS Answers with karma: 3 on 2018-09-07
Post score: 0

A:

Hi,
<param name="RGBD/SavedLocalizationIgnored" type="bool" value="true"/> should be used under rtabmap node, not rgbd_odometry node.
When RGBD/SavedLocalizationIgnored is set to false, rtabmap assumes that the robot is starting from where it stopped mapping, providing the map on start. If the initial localization is wrong (kidnapped robot problem), RTAB-Map will still relocalize the robot on loop closure / global localization. When RGBD/SavedLocalizationIgnored is set to true, rtabmap won't publish the map until it can be localized against the map saved in the database.
The problem here seems that RTAB-Map cannot accept a loop closure / global localization. Can you show warnings on terminal when a loop closure is rejected? <param name="Reg/Strategy" type="string" value="1"/> should be 0 as you don't subscribe to any laser scan inputs. Loop closures may be rejected because there are no scans used. Without a real lidar, I recommend using Reg/Strategy = 0.
I see you have "encoder odometry", make sure there is no conflict with TF sent already by rgbd_odometry. It looks like encoder_odometry and rgbd_odometry are both publishing the same TF /odom -> /base_footprint. This would likely cause strange flickering on TF as both would not give the same transform. You may want to show the tf tree too:
$ rosrun tf view_frames
$ evince frames.pdf

rgbd_odometry is independent of the map, it publishes /odom->/base_footprint. rtabmap publishes the odometry correction on /map -> /odom.
cheers,
Mathieu

Originally posted by matlabbe with karma: 6409 on 2018-09-07
This answer was ACCEPTED on the original site
Post score: 1

Original comments
Comment by rembert on 2018-09-24:
Hi Mathieu
Thanks a lot for your quick response, and most of all for developing this wonderful package.
It works much better now, with Reg/Strategy on 0.
Detecting more loop closures and refining everything in your GUI tool offline seems to help also.
Comment by rembert on 2018-09-24:
We're not publishing other odometry on the tf tree, though I tried before to fuse the encoder signals with the rgdb odometry but than the map was not correct. I might be looking further into that in the future.

