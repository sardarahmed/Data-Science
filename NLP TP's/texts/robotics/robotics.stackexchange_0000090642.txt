Q:

rviz config file for android sensors

Hi,
I'm pretty new to all the ROS ecosystem so please excuse my question if not adequate (and I feel I miss many pieces for the moment...).
I'm wondering; is there a config file for ROS Sensors Driver (http://wiki.ros.org/android_sensors_driver) to use with  $ rosrun rviz riv -d <config_file> in order to plot (on a 2D graph e.g.) sensors' data from an Android device (smartphone)?
The "ROS Sensors Driver" was installed and is successfully connected to ROS master on the laptop running roscore.
I can also successfully print out variation from the IMU chips with $ rostopic echo /android/imu for instance:
header: 
  seq: 384095
  stamp: 
    secs: 1551421044
    nsecs: 381000000
  frame_id: "/imu"
orientation: 
  x: -0.0177525561303
  y: -0.00952073466033
  z: -0.892899274826
  w: 0.449805617332
orientation_covariance: [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]
angular_velocity: 
  x: -0.000991821289062
  y: 0.00173950195312
  z: -0.00140380859375
angular_velocity_covariance: [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]
linear_acceleration: 
  x: 0.445648193359
  y: -0.0185089111328
  z: 9.7029876709
linear_acceleration_covariance: [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]
---

In RViz, I got this warning:
No tf data.  Actual error: Fixed Frame [map] does not exist

And if I run this command in parallel: $ rosrun tf static_transform_publisher 0 0 0 0 0 0 1 map my_frame 10
I have this error:
For frame [/imu]: Frame [/imu] does not exist

I'm running ros melodic 1.14.3 on Ubuntu 18.04 64 bits.
And the "ROS Sensors Driver" app on the Android 6.0.1 smartphone is coming from the playstore.
Thanks.

** Edit: **
Thanks gvdhoorn for the hint. Explanations here under.
I have tried two other things in the meantime:
1) the imu plugin for rviz: http://wiki.ros.org/rviz_imu_plugin : worked like a charm, I'm receiving the /android/imu messages from the $ rosbag play <my_bag_file> command I launched in the same time (I'm now searching how to visualize the device motion relative to the map frame instead of it's own frame, which is giving it a "static look" except for rotations which are fine.
2) rqt_bag: http://wiki.ros.org/rqt_bag : it seems also to work correctly to me but hasn't a graph visualization mode;

Then, I tried your python script to fix the bag file itself in two ways, none of them is working;
a) $ python rosbag_fixer/fix_bag_msg_def.py --use-local-defs -c "/android/imu" "bagfiles/2019-03-01-11-53-15.bag" "bagfiles/2019-03-01-11-53-15_FIX.bag"
which printed:
No topics found for callerid '/android/imu'. Make sure it is correct.

b) $ python rosbag_fixer/fix_bag_msg_def.py --use-local-defs "bagfiles/2019-03-01-11-53-15.bag" "bagfiles/2019-03-01-11-53-15_FIX.bag"
which printed:
Writing out fixed bag ..
 bagfiles/2019-03-01-11-53-15_FIX.bag        100%            687.3 KB 00:00    

done

The new bag probably needs to be re-indexed. Use 'rosbag reindex bagfiles/2019-03-01-11-53-15_FIX.bag' for that.

So I ran the proposed reindex command to fix it.
But then, when launching $ rosbag play on the fixed bag file, it said;
$ rosbag play 2019-03-01-11-53-15_FIX.bag --clock
[ INFO] [1551446760.883611248]: Opening 2019-03-01-11-53-15_FIX.bag

No messages to play on specified topics.  Exiting.

Note; useful pages I found:

https://answers.ros.org/question/266918/possible-to-live-the-data-from-rosbag
http://wiki.ros.org/Bags
http://wiki.ros.org/rosbag/Tutorials/Recording%20and%20playing%20back%20data

along with your code:

https://github.com/gavanderhoorn/rosbag_fixer

[2019-03-04-08-42] Edit 2:
Ok for having append my own answer to the first post, even if it may be more difficult to "follow a discussion" in the future as it becomes more and more detailed.
You're perfectly right on the "plotting" things. I just wanted to point out that "information flow may not (but I'm too new to know if it's the case) be the problem as they are rendered in real time in rviz". But you're right, I'd like to plot some topics as time dependent series. ;)
I also wasn't able to read a bagfile with the python API ( http://wiki.ros.org/rosbag/Code%20API#cpp_api ), running the same kind of error as described here e.g.: https://github.com/jacknlliu/development-issues/issues/39
So, it seems related to rosjava but I'm not sure either. I'm wondering why it hasn't been fixed yet, github issues about that are not recent (??).
When right clicking of the imu topic in the rqt_bag window, I encountered the same python error in the console from where I launch the rqt_bag plot either when I click "Publish" or "View>plot", which finally lead to a core dumped crash:
$ rqt_bag 2019-03-01-11-53-15.bag 
Traceback (most recent call last):
  File "/opt/ros/melodic/lib/python2.7/dist-packages/rqt_bag/bag_timeline.py", line 491, in on_mouse_down
    TimelinePopupMenu(self, event, topic)
  File "/opt/ros/melodic/lib/python2.7/dist-packages/rqt_bag/timeline_menu.py", line 213, in __init__
    self.process(action)
  File "/opt/ros/melodic/lib/python2.7/dist-packages/rqt_bag/timeline_menu.py", line 262, in process
    frame.show(self.timeline.get_context())
  File "/opt/ros/melodic/lib/python2.7/dist-packages/rqt_bag/timeline_menu.py", line 85, in show
    self._viewer = self._viewer_type(self._timeline, self, self._topic)
  File "/opt/ros/melodic/lib/python2.7/dist-packages/rqt_bag_plugins/plot_view.py", line 91, in __init__
    self.plot_widget = PlotWidget(timeline, parent, topic)
  File "/opt/ros/melodic/lib/python2.7/dist-packages/rqt_bag_plugins/plot_view.py", line 176, in __init__
    msg = bag._read_message(entry.position)
  File "/opt/ros/melodic/lib/python2.7/dist-packages/rosbag/bag.py", line 1299, in _read_message
    return self._reader.seek_and_read_message_data_record(position, raw, return_connection_header)
  File "/opt/ros/melodic/lib/python2.7/dist-packages/rosbag/bag.py", line 2842, in seek_and_read_message_data_record
    msg_type = _get_message_type(connection_info)
  File "/opt/ros/melodic/lib/python2.7/dist-packages/rosbag/bag.py", line 1895, in _get_message_type
    message_type = genpy.dynamic.generate_dynamic(info.datatype, info.msg_def)[info.datatype]
  File "/opt/ros/melodic/lib/python2.7/dist-packages/genpy/dynamic.py", line 155, in generate_dynamic
    for l in msg_generator(msg_context, spec, search_path):
  File "/opt/ros/melodic/lib/python2.7/dist-packages/genpy/generator.py", line 741, in msg_generator
    genmsg.msg_loader.load_depends(msg_context, spec, search_path)
  File "/opt/ros/melodic/lib/python2.7/dist-packages/genmsg/msg_loader.py", line 349, in load_depends
    return load_msg_depends(msg_context, spec, msg_search_path)
  File "/opt/ros/melodic/lib/python2.7/dist-packages/genmsg/msg_loader.py", line 318, in load_msg_depends
    depspec = load_msg_by_type(msg_context, resolved_type, search_path)
  File "/opt/ros/melodic/lib/python2.7/dist-packages/genmsg/msg_loader.py", line 125, in load_msg_by_type
    file_path = get_msg_file(package_name, base_type, search_path)
  File "/opt/ros/melodic/lib/python2.7/dist-packages/genmsg/msg_loader.py", line 84, in get_msg_file
    % (base_type, package, search_path), base_type, package, search_path)
genmsg.msg_loader.MsgNotFound: Cannot locate message [Header]: unknown package [std_msgs] on search path [{}]
Aborted (core dumped)

For testing, here is also a bag of 17 seconds, it's a 745K file: https://filebin.ca/4Z0GrGlL6Sno/2019-03-01-11-53-15.bag (hope it will be sufficient).
Its md5 is as follow: 25f0c6b16c2412adb38830a2cc9ed926  bagfiles/2019-03-01-11-53-15.bag
[2019-03-05-16-20] Edit 3:
I recorded 3 new bags (provided in zip file describe hereunder) with topics:
/android/barometric_pressure
/android/imu
/android/<ALL>
Topics with 3 components {x,y,z} are not shown in rqt_plot but topics with 1 component such as barometric_pressure or illuminance are OK and can be displayed while playing back the bag file.
And I run into trouble with every original file with the python API, ending on:
genmsg.msg_loader.MsgNotFound: Cannot locate message [Header]: unknown package [std_msgs] on search path [{}]
plus, the ''FIX_reindexed.bag" files are totally empty now... I don't know why.
And with the -c option I get :
No topics found for callerid '/android/barometric_pressure'. Make sure it is correct.

But rosbag info gives me the right topic:
topics:       /android/barometric_pressure   197 msgs    : sensor_msgs/FluidPressure
Content of the zip file is a follow ( https://filebin.ca/4Z9ZmWu3LrGv/tests_rosjava.zip ):
tests_rosjava
├── [292K]  ALL_2019-03-05-15-36-54.bag
├── [276K]  ALL_2019-03-05-15-36-54_FIX.bag
├── [276K]  ALL_2019-03-05-15-36-54_FIX_reindexed.bag
├── [ 15K]  Barometric_pressure_2019-03-05-15-35-30.bag
├── [ 13K]  Barometric_pressure_2019-03-05-15-35-30_FIX.bag
├── [ 13K]  Barometric_pressure_2019-03-05-15-35-30_FIX_reindexed.bag
├── [1.3K]  commands.txt
├── [185K]  IMU_2019-03-05-15-36-06.bag
├── [179K]  IMU_2019-03-05-15-36-06_FIX.bag
├── [179K]  IMU_2019-03-05-15-36-06_FIX_reindexed.bag
└── [ 660]  md5sum.txt

A commented history of the commands used is in file commands.txt.
md5sum are stored in file md5sum.txt
I keep the original result of the python fix-script as "{basename}_FIX.bag" files, but they needed to be reindexed from what rosbag play was saying when trying to play them.

Originally posted by swiss_knight on ROS Answers with karma: 3 on 2019-02-25
Post score: 0

Original comments
Comment by jubeira on 2019-02-27:
If you want to see the transform properly, what you need is a transform between map and imu. Try running rosrun tf static_transform_publisher 0 0 0 0 0 0 1 /map /imu 10 instead.
Comment by gvdhoorn on 2019-03-01:
Your answer wasn't an answer, so I appended it to your original question text.

A:

I'm wondering; is there a config file for ROS Sensors Driver (http://wiki.ros.org/android_sensors_driver) to use with  $ rosrun rviz riv -d <config_file> in order to plot (on a 2D graph e.g.) sensors' data from an Android device (smartphone)?

I'm not aware of such a config file existing. Not that I'm pretending to know everything, but because RViz is not a "plotting tool", but a 3D rendering environment that happens to know how to visualise ROS msgs that have a spatial aspect to them (ie: a TF frame or some other form of 3D / 6D data).
Plotting could be done using rqt_plot or plotjuggler.

Edit:

I have tried two other things in the meantime:
1) the imu plugin for rviz: http://wiki.ros.org/rviz_imu_plugin : worked like a charm, I'm receiving the /android/imu messages from the $ rosbag play <my_bag_file> command I launched in the same time (I'm now searching how to visualize the device motion relative to the map frame instead of it's own frame, which is giving it a "static look" except for rotations which are fine.

This may be semantics, but when you wrote "plotting", I understood you wanted to be able to visualise a time-varying signal in such a way that its values would be both visualised as well as inspectable at all times captured in your data. RViz does not support that, as it only renders the current state. The IMU plugin is nice, but it doesn't "plot".

2) rqt_bag: http://wiki.ros.org/rqt_bag : it seems also to work correctly to me but hasn't a graph visualization mode;

Try right clicking on one of the rows there. The context menu allows various operations to be performed on the message streams.

Then, I tried your python script to fix the bag file itself in two ways, none of them is working;

Just to clarify: the error message from PlotJuggler made me suspect that you may be running into the issue with rosjava msgs I linked to. I can't be certain.
As to the errors from rosbag_fixer: if you can provide (a short segment of) the bag file, I can take a look.

Edit 2:

Ok for having append my own answer to the first post, even if it may be more difficult to "follow a discussion" in the future as it becomes more and more detailed.

true, but at least we keep the chronological ordering of interactions. ROS Answers is a Q&A type site, which works best if there is (almost) a 1-to-1 ratio of questions and answers. It's fine to post answers yourself, but they should then actually answer the question, not be updates with additional information or progress.
If you'd like, you could put the most recent edit at the top instead of at the bottom of your post.

I also wasn't able to read a bagfile with the python API ( http://wiki.ros.org/rosbag/Code%20API#cpp_api ), running the same kind of error as described here e.g.: https://github.com/jacknlliu/development-issues/issues/39.

That would seem to point to the problem described in rosjava/rosjava_bootstrap#16, which is what rosbag_fixer was created to work around.

So, it seems related to rosjava but I'm not sure either. I'm wondering why it hasn't been fixed yet, github issues about that are not recent (??).

The issue may be old (in fact, I believe this issue has always existed in rosjava), but so far hasn't been annoying enough to rosjava users for them to come up with a fix. As @jubeira writes in rosjava/rosjava_bootstrap#16, rosjava is mostly dependent on community contributions these days, so until someone steps up and fixes it, the problem is going to stay around.

For testing, here is also a bag of 17 seconds, it's a 745K file.

Thanks. I'll see if I can take a look. It does appear rosbag_fixer does something to the file after attempting to "fix" it which rosbag doesn't like. That doesn't surprise me, as rosbag_fixer is doing all sorts of nasty things it isn't supposed to.

Edit 3: I've just "fixed" rosbag_fixer. Turned out the previous version didn't close the bag it was writing properly, which caused loss of data (specifically the index, which contains information on connections and topic types). Commit 3a4ff389 fixes that.
I've just ran all your test bags through the script and can load all of them in PlotJuggler and rosbag play them.
This is obviously not a solution to rosjava/rosjava_bootstrap#16, but at least the work-around works again.

Originally posted by gvdhoorn with karma: 86574 on 2019-02-25
This answer was ACCEPTED on the original site
Post score: 1

Original comments
Comment by swiss_knight on 2019-03-01:
I tried to plot data from the /android/imu topic with rqt_plot but the "plus" button is grayed out; I am unable to proceed to this data visualization. Here is the graph of nodes and topics:
https://reho.st/self/e7b9c51d00da1ded0f4c247c790ec7096b8edf67.png
Comment by swiss_knight on 2019-03-01:
And with plotjugler, when trying to load the sensor_msgs/Imu Datatype from topic /android/imu I get the following error message:
The plugin thrown the following exception: 
This type was not registered

Comment by gvdhoorn on 2019-03-01:
Could be that you're running into #q108956. In short: rosjava (used by ros_android) doesn't send a part of the necessary data to properly introspect messages. You could try running your bag through the rosbag_fixer I mention in #q108956.
Comment by swiss_knight on 2019-03-04:
Edit 2, for more convenience I append it to the first post as well.
Btw, do you know where we can adresse the rosjava issue?
Comment by gvdhoorn on 2019-03-04:
rosjava/rosjava_bootstrap#16 documents it.
Comment by swiss_knight on 2019-03-04:
I just checked all that with an other bag file recorded on the same android device. This one has no values from the IMU topic and I can open it without having to run the fix. The rosjava issue seems only related when working with IMU (and potentially other sources) but not from the pressure sensor
Comment by gvdhoorn on 2019-03-04:
From the data I get from the bag you posted that would seem surprising. All topics, except TF2 and the rosout ones seem to have malformed message_definition headers.
If you have that as a bag I would be interested.
Comment by swiss_knight on 2019-03-04:
Ok, good thing to know, I'm not yet "ROSed" enough to understand fine grained details such as these.
What you said could be a cue for java developers (let's hope). Are git users/devs aware of this detail?
Comment by gvdhoorn on 2019-03-04:
Probably not yet, but I'd first like to make sure.
As I don't have a rosjava publisher, I'm dependent on users like you, that can post bag files showing the problem.
If you could post a bag that you can open, that would be most helpful.
Comment by swiss_knight on 2019-03-04:
Bad quick manipulation from my side; I had to run the fix on the pressure-only data, but it ran nicely and I was then able to plot these data. With IMU data, the fix doesn't run well.
I will double check all this to provide some more bag files, yes.
Comment by gvdhoorn on 2019-03-04:
A bag just showing what you mention here (no IMU data) would be helpful.
Comment by gvdhoorn on 2019-03-05:
I've spent some time tracing what changed between when I wrote rosbag_fixer and the current state of rosbag, but can't really find anything conclusive that would cause the disappearing topics.
I might have some time later, but cannot guarantee it.
Comment by swiss_knight on 2019-03-06:
Update of 1st post with some bag files and explanations. In short; "mono compontent" topics displayed fine in rqt_plot. "multi components" (i.e. containing {x,y,z} values) cann't be add at all (the little "+" is grayed out). I can't read any of the file with python API. And the fixes are empty.
Comment by swiss_knight on 2019-03-06:
What I cannot get is why, for a 12h data file recorded a few days ago, I can plot them in python (using rosbag_pandas package) and not now. The record commands where the same. :/
Comment by gvdhoorn on 2019-03-06:\

And the fixes are empty.

As I already wrote: something seems to have changed, and rosbag_fixer doesn't work reliably at the moment.
The whole script is a hack in any case, so I'm not that surprised. It is unfortunate though.
I don't have time right now to investigate further unfortunately.
Comment by gvdhoorn on 2019-03-06:\

What I cannot get is why, for a 12h data file recorded a few days ago, I can plot them in python (using rosbag_pandas package) and not now. The record commands where the same. :/

well it would be immensely valuable if you could try to figure out what the difference is between when things ..
Comment by gvdhoorn on 2019-03-06:
.. worked and when they don't (ie: now).
That could provide a clue.
I do know though: rosjava hasn't changed, and the messages don't contain the full message definition in the connection headers, which leads to the problems with rosbag's read_messages(..).
Comment by gvdhoorn on 2019-03-06:
@swiss_knight: just got things working again. Trivial fix. See latest edit.
Comment by swiss_knight on 2019-03-06:
That's great; it works with Python now! :D
Many thanks for your commit gvdhoorn!

