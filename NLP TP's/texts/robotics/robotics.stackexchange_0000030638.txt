Q:

videre_stereo_cam segmentation fault

Hi everyone,
I'm trying to make "videre_stereo_cam" package to work with a VIDERE STOC camera 6cm baseline.
The problem is that videre_stereo_node crashes reporting a segmentation fault. I believe that something goes wrong when frame deinterlacing takes place, but I'm not sure.
Using SVS software for Linux, I can access the camera and get disparity image. Unfortunately, SVS is precompiled for 32bit architectures and Videre does not provide support for this product any more. My operating system is 64bit.
System Information:

videre_stereo_cam svn revision 1290

ROS Diamondback

Linux 2.6.32-29-generic #58-Ubuntu SMP Fri Feb 11 20:52:10 UTC 2011 x86_64 GNU/Linux

libdc1394-22  libdc1394-22-dev  libdc1394-utils  libraw1394-dev  libraw1394-11

When I first tried to compile videre_stereo_cam, compilation failed.

This code block was moved to the following github gist:
https://gist.github.com/answers-se-migration-openrobotics/400e97291da5246411a3b4d46a48a23e

Then, I made some changes:

changed at stereoImage.cpp, line 258: cam_info.D.c_array() -> cam_info.D.data()

changed at stereoImage.cpp, line 518: left_info.D.c_array() -> left_info.D.data()

changed at stereoImage.cpp, line 532: right_info.D.c_array() -> right_info.D.data()

added at stereoImage.cpp, line 225: cam_info.D = std::vector(5);

and compilation finished successfully.
pandora@pandora-hardware:~/pandorasvn/ros/videre_stereo_cam$ rosmake
[ rosmake ] No package specified.  Building ['videre_stereo_cam']      
[ rosmake ] Packages requested are: ['videre_stereo_cam']                                                                     
[ rosmake ] Logging to directory/home/pandora/.ros/rosmake/rosmake_output-20110323-195141
[ rosmake ] Expanded args ['videre_stereo_cam'] to:
['videre_stereo_cam']                                                                                                        
[ rosmake ] Checking rosdeps compliance for packages videre_stereo_cam.  This may take a few seconds.
Failed to find rosdep libdc1394-dev for package videre_stereo_cam on OS:ubuntu version:10.04
WARNING: Rosdeps [u'libdc1394-dev'] could not be resolved
[ rosmake ] rosdep check passed all system dependencies in packages                                                                                                    
[rosmake-0] Starting >>> rosbuild [ make ]
[rosmake-0] Finished <<< rosbuild ROS_NOBUILD in package rosbuild
 No Makefile in package rosbuild                                                                               
[rosmake-1] Starting >>> cpp_common [ make ]                                       
[rosmake-1] Finished <<< cpp_common ROS_NOBUILD in package cpp_common                                                                                  
[rosmake-2] Starting >>> roslib [ make ]
[rosmake-2] Finished <<< roslib ROS_NOBUILD in package roslib                                       
[rosmake-3] Starting >>> xmlrpcpp [ make ]                                                                                                 
[rosmake-0] Starting >>> roslang [ make ]
[rosmake-1] Starting >>> roscpp_traits [ make ]                                      
[rosmake-2] Starting >>> rostime [ make ]                                                                                  
[rosmake-0] Finished <<< roslang ROS_NOBUILD in package roslang
 No Makefile in package roslang                                                                                  
[rosmake-1] Finished <<< roscpp_traits ROS_NOBUILD in package roscpp_traits
[rosmake-3] Finished <<< xmlrpcpp ROS_NOBUILD in package xmlrpcpp                                                                          
[rosmake-2] Finished <<< rostime ROS_NOBUILD in package rostime
[rosmake-0] Starting >>> std_msgs [ make ]                                                            
[rosmake-1] Starting >>> roscpp_serialization [ make ]                                                                                                   
[rosmake-3] Starting >>> rosconsole [ make ]
[rosmake-3] Finished <<< rosconsole ROS_NOBUILD in package rosconsole                                           
[rosmake-0] Finished <<< std_msgs ROS_NOBUILD in package std_msgs                                       
[rosmake-1] Finished <<< roscpp_serialization ROS_NOBUILD in package roscpp_serialization
[rosmake-2] Starting >>> rosgraph_msgs [ make ]                                                                                      
[rosmake-2] Finished <<< rosgraph_msgs ROS_NOBUILD in package rosgraph_msgs
[rosmake-3] Starting >>> opencv2 [ make ]                                                                        
[rosmake-3] Finished <<< opencv2 ROS_NOBUILD in package opencv2
[rosmake-0] Starting >>> rosclean [ make ]                                                            
[rosmake-0] Finished <<< rosclean ROS_NOBUILD in package rosclean                                                       
[rosmake-1] Starting >>> rosgraph [ make ]                                                                                                                     
[rosmake-2] Starting >>> roscpp [ make ]
[rosmake-3] Starting >>> rospy [ make ]                                     
[rosmake-1] Finished <<< rosgraph ROS_NOBUILD in package rosgraph                                                                           
[rosmake-2] Finished <<< roscpp ROS_NOBUILD in package roscpp
[rosmake-3] Finished <<< rospy ROS_NOBUILD in package rospy                                                            
[rosmake-0] Starting >>> rosmaster [ make ]                                                                                                                    
[rosmake-0] Finished <<< rosmaster ROS_NOBUILD in package rosmaster
[rosmake-1] Starting >>> rosout [ make ]                                                                
[rosmake-1] Finished <<< rosout ROS_NOBUILD in package rosout                                                                                                       
[rosmake-2] Starting >>> rosunit [ make ]
[rosmake-2] Finished <<< rosunit ROS_NOBUILD in package rosunit                                        
[rosmake-3] Starting >>> yaml_cpp [ make ]                                                                                                    
[rosmake-0] Starting >>> roslaunch [ make ]
[rosmake-3] Finished <<< yaml_cpp ROS_NOBUILD in package yaml_cpp                                          
[rosmake-0] Finished <<< roslaunch ROS_NOBUILD in package roslaunch
 No Makefile in package roslaunch                                                                            
[rosmake-1] Starting >>> tinyxml [ make ]                                                                                                          
[rosmake-1] Finished <<< tinyxml ROS_NOBUILD in package tinyxml
[rosmake-2] Starting >>> bond [ make ]                                                            
[rosmake-3] Starting >>> rostest [ make ]                                                                                               
[rosmake-0] Starting >>> pluginlib [ make ]
[rosmake-0] Finished <<< pluginlib ROS_NOBUILD in package pluginlib                                          
[rosmake-3] Finished <<< rostest ROS_NOBUILD in package rostest                                                      
[rosmake-2] Finished <<< bond ROS_NOBUILD in package bond
[rosmake-1] Starting >>> smclib [ make ]                                                      
[rosmake-0] Starting >>> topic_tools [ make ]                                                                                           
[rosmake-3] Starting >>> message_filters [ make ]
[rosmake-1] Finished <<< smclib ROS_NOBUILD in package smclib                                                
[rosmake-3] Finished <<< message_filters ROS_NOBUILD in package message_filters
[rosmake-0] Finished <<< topic_tools ROS_NOBUILD in package topic_tools                                                                              
[rosmake-2] Starting >>> bullet [ make ]
[rosmake-3] Starting >>> bondcpp [ make ]                                     
[rosmake-1] Starting >>> rosbag [ make ]                                                                           
[rosmake-2] Finished <<< bullet ROS_NOBUILD in package bullet                                                          
[rosmake-3] Finished <<< bondcpp ROS_NOBUILD in package bondcpp
[rosmake-1] Finished <<< rosbag ROS_NOBUILD in package rosbag                                                              
[rosmake-0] Starting >>> angles [ make ]                                                                                                                        
[rosmake-2] Starting >>> rosbagmigration [ make ]
[rosmake-3] Starting >>> rosmsg [ make ]                                              
[rosmake-1] Starting >>> nodelet [ make ]                                                                                   
[rosmake-0] Finished <<< angles ROS_NOBUILD in package angles
[rosmake-1] Finished <<< nodelet ROS_NOBUILD in package nodelet                                                            
[rosmake-3] Finished <<< rosmsg ROS_NOBUILD in package rosmsg
 No Makefile in package rosmsg                                                                                     
[rosmake-2] Finished <<< rosbagmigration ROS_NOBUILD in package rosbagmigration
 No Makefile in package rosbagmigration                                                          
[rosmake-0] Starting >>> rosnode [ make ]                                                                                                                
[rosmake-1] Starting >>> geometry_msgs [ make ]
[rosmake-2] Starting >>> rostopic [ make ]                                            
[rosmake-3] Starting >>> diagnostic_msgs [ make ]                                                                                   
[rosmake-0] Finished <<< rosnode ROS_NOBUILD in package rosnode
[rosmake-1] Finished <<< geometry_msgs ROS_NOBUILD in package geometry_msgs                                                              
[rosmake-2] Finished <<< rostopic ROS_NOBUILD in package rostopic
[rosmake-3] Finished <<< diagnostic_msgs ROS_NOBUILD in package diagnostic_msgs                                                                
[rosmake-2] Starting >>> rosservice [ make ]
[rosmake-1] Starting >>> sensor_msgs [ make ]                                         
[rosmake-3] Starting >>> diagnostic_updater [ make ]                                                                                   
[rosmake-1] Finished <<< sensor_msgs ROS_NOBUILD in package sensor_msgs
[rosmake-1] Starting >>> cv_bridge [ make ]                                                                    
[rosmake-0] Starting >>> camera_calibration_parsers [ make ]                                                                                                            
[rosmake-3] Finished <<< diagnostic_updater ROS_NOBUILD in package diagnostic_updater
[rosmake-3] Starting >>> image_geometry [ make ]                                                                                  
[rosmake-1] Finished <<< cv_bridge ROS_NOBUILD in package cv_bridge
[rosmake-2] Finished <<< rosservice ROS_NOBUILD in package rosservice                                                                  
[rosmake-2] Starting >>> dynamic_reconfigure [ make ]
[rosmake-1] Starting >>> image_transport [ make ]                                                  
[rosmake-0] Finished <<< camera_calibration_parsers ROS_NOBUILD in package camera_calibration_parsers
[rosmake-0] Starting >>> stereo_msgs [ make ]                                         
[rosmake-2] Finished <<< dynamic_reconfigure ROS_NOBUILD in package dynamic_reconfigure                                                                                     
[rosmake-3] Finished <<< image_geometry ROS_NOBUILD in package image_geometry
[rosmake-1] Finished <<< image_transport ROS_NOBUILD in package image_transport                                                                            
[rosmake-2] Starting >>> self_test [ make ]
[rosmake-0] Finished <<< stereo_msgs ROS_NOBUILD in package stereo_msgs                                          
[rosmake-3] Starting >>> roswtf [ make ]                                                                                                              
[rosmake-1] Starting >>> image_proc [ make ]
[rosmake-1] Finished <<< image_proc ROS_NOBUILD in package image_pro                                                                 
[rosmake-1] Starting >>> stereo_image_proc [ mak                                                             
[rosmake-2] Finished <<< self_test ROS_NOBUILD in package self_tes                                                               
[rosmake-2] Starting >>> driver_base [ mak                                                                     
[rosmake-3] Finished <<< roswtf ROS_NOBUILD in package roswt                                                                           
[rosmake-3] Starting >>> tf [ mak                                                                                    
[rosmake-1] Finished <<< stereo_image_proc ROS_NOBUILD in package stereo_image_pro                                                              
[rosmake-2] Finished <<< driver_base ROS_NOBUILD in package driver_bas                         
[rosmake-3] Finished <<< tf ROS_NOBUILD in package tf                                                     
[rosmake-3] Starting >>> videre_stereo_cam [ make ]                                                                                                       
[ rosmake ] Output from build of package videre_stereo_cam written to:                                   
[ 1 Active 55/56 Complete ]
[ rosmake ]    /home/pandora/.ros/rosmake/rosmake_output-20110323-195141/videre_stereo_cam/build_output.log
[rosmake-3] Finished <<< videre_stereo_cam [PASS] [ 13.50 seconds ] -- WARNING: 2 compiler warnings
[ rosmake ] Results:                                                                                                 
[ rosmake ] Built 56 packages with 0 failures.                                                                                                                   
[ rosmake ] Summary output to directory
[ rosmake ] /home/pandora/.ros/rosmake/rosmake_output-20110323-195141

I made some changes in videre.launch file, like setting videre_mode to "diparity" and respawn to "false". I also added some "cout" in the code. The output, after launching the node is the following:
roslaunch videre_stereo_cam videre.launch 
... logging to /home/pandora/.ros/log/726543d2-557b-11e0-8bbd-6c626d7fdf37/roslaunch-pandora-hardware-15060.log
Checking log directory for disk usage. This may take awhile.
Press Ctrl-C to interrupt
Done checking log file disk usage. Usage is <1GB.

started roslaunch server http://pandora-hardware:33597/

SUMMARY
========

PARAMETERS
 * /rosdistro
 * /stereo/videre_stereo_cam/fps
 * /stereo/videre_stereo_cam/exposure_auto
 * /stereo/videre_stereo_cam/frame_id
 * /rosversion
 * /stereo/videre_stereo_cam/gain_auto
 * /stereo/videre_stereo_cam/brightness_auto
 * /stereo/videre_stereo_cam/videre_mode
 * /stereo/videre_stereo_cam/convert_to_color

NODES
  /stereo/
    videre_stereo_cam (videre_stereo_cam/videre_stereo_node)

auto-starting new master

process[master]: started with pid [15074]

ROS_MASTER_URI=http://localhost:11311

setting /run_id to 726543d2-557b-11e0-8bbd-6c626d7fdf37

process[rosout-1]: started with pid [15087]

started core service [/rosout]

process[stereo/videre_stereo_cam-2]: started with pid [15090]

[ INFO] [1300904951.382398332]: Resetting bus

[ INFO] [1300904951.384887386]: Initializing camera, turning off ISO

[ INFO] [1300904951.446575186]: [dcam] Videre camera, getting local params

[ INFO] [1300904951.447000106]: [dcam] Camera firmware: 06.02

[ INFO] [1300904951.447611575]: [dcam] Imager firmware: 0006

[ INFO] [1300904951.447722601]: [Dcam] Found stereo device

[ INFO] [1300904951.448114471]: [dcam] STOC version: 04.02

procMode is 4

[ INFO] [1300904951.449268614]: [dcam] STOC thresholds: 00010c0a

[ INFO] [1300904951.746888628]: [dcam] Calibration, 1973 bytes

[ INFO] [1300904951.748603804]: [dcam] Color device

VidereStereoDriver::setRawType , Stereo camera is in PROC_MODE_DISPARITY mode!

VidereStereoDriver::setRawType , isStoc , VIDERE_STOC_RECT_DISP

[ INFO] [1300904951.749113752]: [dcam] Feature register hi: d2800000

[ INFO] [1300904951.749736725]: [dcam] Feature register lo: 00000000

[ INFO] [1300904951.753768763]: [Dcam] Exposure min/max: [0,529]

[ INFO] [1300904951.757776740]: [Dcam] Gain min/max: [0,48]

[ INFO] [1300904951.761810039]: [Dcam] Brightness min/max: [0,255]

[ INFO] [1300904951.764106769]: [Dcam] Whitebalance min/max: [0,30]

[extractParams] Parameters:

[dcam] SVS-type parameters

[dcam] Disparity resolution: 1/16 pixel

[dcam] Correlation window: 15

[dcam] Prefilter window: 9

[dcam] Number of disparities: 64

[dcam] left camera matrix (K)
 422.1117 0.0000 319.4246
 0.0000 425.1450 260.2131
 0.0000 0.0000 1.0000

[dcam] left distortion vector (D)
 -0.3299 0.1109 0.0000 0.0000 0.0000

[dcam] left rectification matrix (R)
 0.9999 0.0088 -0.0072
 -0.0088 1.0000 -0.0014
 0.0072 0.0015 1.0000

[dcam] left projection matrix (P)
 425.0000 0.0000 323.1876 0.0000
 0.0000 425.0000 243.5984 0.0000
 0.0000 0.0000 1.0000 0.0000

[dcam] right camera matrix (K)
 413.6503 0.0000 327.6238
 0.0000 416.6324 226.3288
 0.0000 0.0000 1.0000

[dcam] right distortion vector (D)
 -0.3362 0.1210 0.0000 0.0000 0.0000

[dcam] right rectification matrix (R)
 1.0000 0.0067 -0.0047
 -0.0067 1.0000 0.0014
 0.0047 -0.0014 1.0000

[dcam] right projection matrix (P)
 425.0000 0.0000 323.1876 -25.5966
 0.0000 425.0000 243.5984 0.0000
 0.0000 0.0000 1.0000 0.0000

[dcam] Has rectification

[dcam] External translation vector
 -0.0602 -0.0004 0.0003

[dcam] External rotation vector
 0.0028 -0.0025 -0.0022

[ INFO] [1300904952.043839488]: Connecting to camera with GUID 23930887758950775 [VIDERE_DESIGN MDS-STH]

[ INFO] [1300904952.044058224]: Connected camera is a STOC device

VidereStereoDriver::setRawType , Stereo camera is in PROC_MODE_DISPARITY mode!

VidereStereoDriver::setRawType , isStoc , VIDERE_STOC_RECT_DISP

[ INFO] [1300904952.369705399]: Camera reconfigure request received, level 0xffffffff

[ INFO] [1300904952.372257414]: Setting mode to disparity

[ INFO] [1300904952.372358964]: Color conversion from Bayer pattern is Enabled

setProcMode to 4

VidereStereoDriver::setRawType , Stereo camera is in PROC_MODE_DISPARITY mode!

VidereStereoDriver::setRawType , isStoc , VIDERE_STOC_RECT_DISP

[ INFO] [1300904952.926187210]: Stereo camera's frame ID is /stereo_optical_frame

[ INFO] [1300904952.926324933]: Setting Exposure to Auto setting

[ INFO] [1300904952.926408416]: Setting Gain to Auto setting

[ INFO] [1300904952.926487878]: Setting Brightness to Auto setting

[ INFO] [1300904952.926585922]: Setting Whitebalance to Auto setting

[ INFO] [1300904952.926687317]: Companding mode is Enabled

[ INFO] [1300904952.926789981]: High Dynamic Range mode is Disabled

[ INFO] [1300904953.077378989]: STOC: uniqueness threshold is set to 36

[ INFO] [1300904953.077588429]: STOC: texture threshold is set to 30

[ INFO] [1300904953.077673118]: STOC: speckle size is set to 100

[ INFO] [1300904953.077751131]: STOC: speckle range is set to 10

[ INFO] [1300904953.077829163]: STOC: horopter is set to 0

[ INFO] [1300904953.077911825]: -------------------------------------------

[ INFO] [1300904953.429432413]: Streaming...

VidereStereoDriver::getImage : camFrame size is 640 x 480

VidereStereoDriver::getImage : inside isVidereStereo

case VIDERE_STOC_RECT_DISP

VidereStereoDriver::stereoDeinterlace2

color coding is 353

color filter is 0

data depth is 8

video mode is 66

image bytes are 460800

stride is 960

total_bytes are 460800

image_bytes are 460800

padding_bytes is 0

yuv byte order 800

timestamp : 1300913179427341

id is 7

memory alloc : 3330165771444695856

width is 640 height is 480

imDtop is 11

imDleft is 74

imDwidth is 555

imDheight is 456

System segfaulted, stopping camera nicely

[stereo/videre_stereo_cam-2] process has died [pid 15090, exit code -11].

log files: /home/pandora/.ros/log/726543d2-557b-11e0-8bbd-6c626d7fdf37/stereo-videre_stereo_cam-2*.log

^C[rosout-1] killing on exit
[master] killing on exit
shutting down processing monitor...
... shutting down processing monitor complete
done

Running the node with kdbg, found that the segmentation fault, occurs in stereoDeinterlace2 method, in the last for loop.
I'm sorry for the huge message! I hope someone could help!
Michael Skolarikis
PANDORA Robotics Team
Originally posted by Michael Skolarikis on ROS Answers with karma: 16 on 2011-03-23
Post score: 0

A:

Problem solved!!!
My Videre STOC camera sends image data as 2byte pixels in YUV422 format.
For some reason, the camera reports that the frame it sends is in YUV411 format!
YUV422 bit size is set to 16, instead of YUV411 which is set to 12 in dc1394/utils.c.
This was causing incomplete frames.
In libdc1394-2.1.2, at dc1394/control.c, line 672 I made the following change:
*mode= (uint32_t)((value >> 29) & 0x7UL) + DC1394_VIDEO_MODE_FORMAT0_MIN;

->
*mode= DC1394_VIDEO_MODE_640x480_YUV422;

Maybe there is a more elegant solution to this problem. The important thing for me is that I can finally get frames and point clouds!
Thank you very much Anton for your time!

Originally posted by Michael Skolarikis with karma: 16 on 2011-04-01
This answer was ACCEPTED on the original site
Post score: 0

Original comments
Comment by Michael Skolarikis on 2011-04-11:
At videre_stereo_1394.cpp , line 422 CHECK_ERR_CLEAN(dc1394_video_set_mode(dcCam, video), "Could not set video mode"); is not working for video = DC1394_VIDEO_MODE_640x480_YUV422. It does not report an error, but it sets the video_mode to  DC1394_VIDEO_MODE_640x480_YUV411.
Comment by Michael Skolarikis on 2011-04-06:
The code is exactly as you say, but the dcframe received from firewire has different mode. I'll try to track video mode, in libdc1394 and see where is the dcframe created and why it has wrong video mode. As you can see from the outputs above,  video mode is 66 -> YUV411
Comment by arebgun on 2011-04-04:
That's pretty strange considering the driver explicitly sets the format to DC1394_VIDEO_MODE_640x480_YUV422 or DC1394_VIDEO_MODE_320x240_YUV422 depending on desired resolution (see line 269 in videre_stereo_node.cpp, and line 397 in videre_stereo_1394.cpp)... maybe something is not right there?
Comment by ffusion on 2012-11-12:
Michael I guess I'm having the same problem. Where can I find the files to modify, please?

