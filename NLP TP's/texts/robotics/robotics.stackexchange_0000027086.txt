Q:

Gazebo aborts with boost::lock_error when removing a model with physics::World::RemoveModel

Hi
I am using the gazebo simulator version 3.1 without ROS and trying to develop my own worldplugin and modelplugin. After I tried to remove an existing model from the world using the physics::World::RemoveModel method, i got an error
terminate called after throwing an instance of 'boost::exception_detail::clone_impl<boost::exception_detail::error_info_injector<boost::lock_error> >'
  what():  boost: mutex lock failed in pthread_mutex_lock: Invalid argument

Here are the traceback from gdb
#0  0x00007ffff4b6bf79 in raise () from /lib/x86_64-linux-gnu/libc.so.6
#1  0x00007ffff4b6f388 in abort () from /lib/x86_64-linux-gnu/libc.so.6
#2  0x00007ffff51716b5 in __gnu_cxx::__verbose_terminate_handler() () from /usr/lib/x86_64-linux-gnu/libstdc++.so.6
#3  0x00007ffff516f836 in ?? () from /usr/lib/x86_64-linux-gnu/libstdc++.so.6
#4  0x00007ffff516f863 in std::terminate() () from /usr/lib/x86_64-linux-gnu/libstdc++.so.6
#5  0x00007ffff516faa2 in __cxa_throw () from /usr/lib/x86_64-linux-gnu/libstdc++.so.6
#6  0x00007ffff752d753 in boost::throw_exception<boost::lock_error> (e=...) at /usr/include/boost/throw_exception.hpp:67
#7  0x00007ffff7523a36 in boost::mutex::lock (this=0x7fff70c78920) at /usr/include/boost/thread/pthread/mutex.hpp:116
#8  0x00007ffff752dc3a in boost::unique_lock<boost::mutex>::lock (this=0x7fffde00b570) at /usr/include/boost/thread/lock_types.hpp:346
#9  0x00007ffff752dac1 in boost::unique_lock<boost::mutex>::unique_lock (this=0x7fffde00b570, m_=...)
    at /usr/include/boost/thread/lock_types.hpp:124
#10 0x00007ffff756b819 in gazebo::transport::Publisher::OnPublishComplete (this=0x7fff70c788e0, _id=1)
    at /home/asl/SMORES/gazebo_source/gazebo/gazebo/transport/Publisher.cc:227
#11 0x00007ffff756ed8b in boost::_mfi::mf1<void, gazebo::transport::Publisher, unsigned int>::operator() (this=0x7fffd80045d8, p=0x7fff70c788e0, 
    a1=1) at /usr/include/boost/bind/mem_fn_template.hpp:165
#12 0x00007ffff756eaf5 in boost::_bi::list2<boost::_bi::value<gazebo::transport::Publisher*>, boost::arg<1> >::operator()<boost::_mfi::mf1<void, gazebo::transport::Publisher, unsigned int>, boost::_bi::list1<unsigned int&> > (this=0x7fffd80045e8, f=..., a=...)
    at /usr/include/boost/bind/bind.hpp:313
#13 0x00007ffff756e81c in boost::_bi::bind_t<void, boost::_mfi::mf1<void, gazebo::transport::Publisher, unsigned int>, boost::_bi::list2<boost::_bi::value<gazebo::transport::Publisher*>, boost::arg<1> > >::operator()<unsigned int> (this=0x7fffd80045d8, a1=@0x7fffde00b664: 1)
    at /usr/include/boost/bind/bind_template.hpp:32
#14 0x00007ffff756e195 in boost::detail::function::void_function_obj_invoker1<boost::_bi::bind_t<void, boost::_mfi::mf1<void, gazebo::transport::Publisher, unsigned int>, boost::_bi::list2<boost::_bi::value<gazebo::transport::Publisher*>, boost::arg<1> > >, void, unsigned int>::invoke (
    function_obj_ptr=..., a0=1) at /usr/include/boost/function/function_template.hpp:153
#15 0x00007ffff753148a in boost::function1<void, unsigned int>::operator() (this=0x7fffd80045d0, a0=1)
    at /usr/include/boost/function/function_template.hpp:767
#16 0x00007ffff751f255 in gazebo::transport::Connection::OnWrite (this=0x7fffd80034b0, _e=...)
    at /home/asl/SMORES/gazebo_source/gazebo/gazebo/transport/Connection.cc:383
#17 0x00007ffff7540e49 in boost::_mfi::mf1<void, gazebo::transport::Connection, boost::system::error_code const&>::call<boost::shared_ptr<gazebo::transport::Connection>, boost::system::error_code const> (this=0x7fffde00b9b8, u=..., b1=...) at /usr/include/boost/bind/mem_fn_template.hpp:156
#18 0x00007ffff753f4e0 in boost::_mfi::mf1<void, gazebo::transport::Connection, boost::system::error_code const&>::operator()<boost::shared_ptr<gazebo::transport::Connection> > (this=0x7fffde00b9b8, u=..., a1=...) at /usr/include/boost/bind/mem_fn_template.hpp:171
#19 0x00007ffff753d441 in boost::_bi::list2<boost::_bi::value<boost::shared_ptr<gazebo::transport::Connection> >, boost::arg<1> (*)()>::operator()<boost::_mfi::mf1<void, gazebo::transport::Connection, boost::system::error_code const&>, boost::_bi::list2<boost::system::error_code const&, unsigned long const&> > (this=0x7fffde00b9c8, f=..., a=...) at /usr/include/boost/bind/bind.hpp:313
#20 0x00007ffff7539e90 in boost::_bi::bind_t<void, boost::_mfi::mf1<void, gazebo::transport::Connection, boost::system::error_code const&>, boost::_bi::list2<boost::_bi::value<boost::shared_ptr<gazebo::transport::Connection> >, boost::arg<1> (*)()> >::operator()<boost::system::error_code, unsigned long> (this=0x7fffde00b9b8, a1=..., a2=@0x7fffde00b9b0: 642) at /usr/include/boost/bind/bind_template.hpp:102
---Type <return> to continue, or q <return> to quit---
#21 0x00007ffff7535e7b in boost::asio::detail::write_op<boost::asio::basic_stream_socket<boost::asio::ip::tcp, boost::asio::stream_socket_service<boost::asio::ip::tcp> >, boost::asio::const_buffers_1, boost::asio::detail::transfer_all_t, boost::_bi::bind_t<void, boost::_mfi::mf1<void, gazebo::transport::Connection, boost::system::error_code const&>, boost::_bi::list2<boost::_bi::value<boost::shared_ptr<gazebo::transport::Connection> >, boost::arg<1> (*)()> > >::operator() (this=0x7fffde00b990, ec=..., bytes_transferred=642, start=0)
    at /usr/include/boost/asio/impl/write.hpp:345
#22 0x00007ffff75434dc in boost::asio::detail::binder2<boost::asio::detail::write_op<boost::asio::basic_stream_socket<boost::asio::ip::tcp, boost::asio::stream_socket_service<boost::asio::ip::tcp> >, boost::asio::const_buffers_1, boost::asio::detail::transfer_all_t, boost::_bi::bind_t<void, boost::_mfi::mf1<void, gazebo::transport::Connection, boost::system::error_code const&>, boost::_bi::list2<boost::_bi::value<boost::shared_ptr<gazebo::transport::Connection> >, boost::arg<1> (*)()> > >, boost::system::error_code, unsigned long>::operator() (this=0x7fffde00b990)
    at /usr/include/boost/asio/detail/bind_handler.hpp:127
#23 0x00007ffff7543370 in boost::asio::asio_handler_invoke<boost::asio::detail::binder2<boost::asio::detail::write_op<boost::asio::basic_stream_socket<boost::asio::ip::tcp, boost::asio::stream_socket_service<boost::asio::ip::tcp> >, boost::asio::const_buffers_1, boost::asio::detail::transfer_all_t, boost::_bi::bind_t<void, boost::_mfi::mf1<void, gazebo::transport::Connection, boost::system::error_code const&>, boost::_bi::list2<boost::_bi::value<boost::shared_ptr<gazebo::transport::Connection> >, boost::arg<1> (*)()> > >, boost::system::error_code, unsigned long> > (
    function=...) at /usr/include/boost/asio/handler_invoke_hook.hpp:64
#24 0x00007ffff7543132 in boost_asio_handler_invoke_helpers::invoke<boost::asio::detail::binder2<boost::asio::detail::write_op<boost::asio::basic_stream_socket<boost::asio::ip::tcp, boost::asio::stream_socket_service<boost::asio::ip::tcp> >, boost::asio::const_buffers_1, boost::asio::detail::transfer_all_t, boost::_bi::bind_t<void, boost::_mfi::mf1<void, gazebo::transport::Connection, boost::system::error_code const&>, boost::_bi::list2<boost::_bi::value<boost::shared_ptr<gazebo::transport::Connection> >, boost::arg<1> (*)()> > >, boost::system::error_code, unsigned long>, boost::_bi::bind_t<void, boost::_mfi::mf1<void, gazebo::transport::Connection, boost::system::error_code const&>, boost::_bi::list2<boost::_bi::value<boost::shared_ptr<gazebo::transport::Connection> >, boost::arg<1> (*)()> > > (function=..., context=...)
    at /usr/include/boost/asio/detail/handler_invoke_helpers.hpp:37
#25 0x00007ffff7542c65 in boost::asio::detail::asio_handler_invoke<boost::asio::detail::binder2<boost::asio::detail::write_op<boost::asio::basic_stream_socket<boost::asio::ip::tcp, boost::asio::stream_socket_service<boost::asio::ip::tcp> >, boost::asio::const_buffers_1, boost::asio::detail::transfer_all_t, boost::_bi::bind_t<void, boost::_mfi::mf1<void, gazebo::transport::Connection, boost::system::error_code const&>, boost::_bi::list2<boost::_bi::value<boost::shared_ptr<gazebo::transport::Connection> >, boost::arg<1> (*)()> > >, boost::system::error_code, unsigned long>, boost::asio::basic_stream_socket<boost::asio::ip::tcp, boost::asio::stream_socket_service<boost::asio::ip::tcp> >, boost::asio::const_buffers_1, boost::asio::detail::transfer_all_t, boost::_bi::bind_t<void, boost::_mfi::mf1<void, gazebo::transport::Connection, boost::system::error_code const&>, boost::_bi::list2<boost::_bi::value<boost::shared_ptr<gazebo::transport::Connection> >, boost::arg<1> (*)()> > > (function=..., 
    this_handler=0x7fffde00baa0) at /usr/include/boost/asio/impl/write.hpp:565
#26 0x00007ffff754269d in boost_asio_handler_invoke_helpers::invoke<boost::asio::detail::binder2<boost::asio::detail::write_op<boost::asio::basic_stream_socket<boost::asio::ip::tcp, boost::asio::stream_socket_service<boost::asio::ip::tcp> >, boost::asio::const_buffers_1, boost::asio::detail::transfer_all_t, boost::_bi::bind_t<void, boost::_mfi::mf1<void, gazebo::transport::Connection, boost::system::error_code const&>, boost::_bi::list2<boost::_bi::value<boost::shared_ptr<gazebo::transport::Connection> >, boost::arg<1> (*)()> > >, boost::system::error_code, unsigned long>, boost::asio::detail::write_op<boost::asio::basic_stream_socket<boost::asio::ip::tcp, boost::asio::stream_socket_service<boost::asio::ip::tcp> >, boost::asio::const_buffers_1, boost::asio::detail::transfer_all_t, boost::_bi::bind_t<void, boost::_mfi::mf1<void, gazebo::transport::Connection, boost::system::error_code const&>, boost::_bi::list2<boost::_bi::value<boost::shared_ptr<gazebo::transport::Connection> >, boost::arg<1> (*)()> > > >
    (function=..., context=...) at /usr/include/boost/asio/detail/handler_invoke_helpers.hpp:37
---Type <return> to continue, or q <return> to quit---
#27 0x00007ffff7541e03 in boost::asio::detail::reactive_socket_send_op<boost::asio::const_buffers_1, boost::asio::detail::write_op<boost::asio::basic_stream_socket<boost::asio::ip::tcp, boost::asio::stream_socket_service<boost::asio::ip::tcp> >, boost::asio::const_buffers_1, boost::asio::detail::transfer_all_t, boost::_bi::bind_t<void, boost::_mfi::mf1<void, gazebo::transport::Connection, boost::system::error_code const&>, boost::_bi::list2<boost::_bi::value<boost::shared_ptr<gazebo::transport::Connection> >, boost::arg<1> (*)()> > > >::do_complete (owner=0x71a640, 
    base=0x7fff9800bf50) at /usr/include/boost/asio/detail/reactive_socket_send_op.hpp:107
#28 0x00007ffff7525514 in boost::asio::detail::task_io_service_operation::complete (this=0x7fff9800bf50, owner=..., ec=..., bytes_transferred=0)
    at /usr/include/boost/asio/detail/task_io_service_operation.hpp:37
#29 0x00007ffff7527db1 in boost::asio::detail::task_io_service::do_run_one (this=0x71a640, lock=..., this_thread=..., ec=...)
    at /usr/include/boost/asio/detail/impl/task_io_service.ipp:384
#30 0x00007ffff7527899 in boost::asio::detail::task_io_service::run (this=0x71a640, ec=...)
    at /usr/include/boost/asio/detail/impl/task_io_service.ipp:153
#31 0x00007ffff7528179 in boost::asio::io_service::run (this=0x719a50) at /usr/include/boost/asio/impl/io_service.ipp:59
#32 0x00007ffff75568c3 in boost::_mfi::mf0<unsigned long, boost::asio::io_service>::operator() (this=0x71a8a8, p=0x719a50)
    at /usr/include/boost/bind/mem_fn_template.hpp:49
#33 0x00007ffff7556827 in boost::_bi::list1<boost::_bi::value<boost::asio::io_service*> >::operator()<unsigned long, boost::_mfi::mf0<unsigned long, boost::asio::io_service>, boost::_bi::list0> (this=0x71a8b8, f=..., a=...) at /usr/include/boost/bind/bind.hpp:243
#34 0x00007ffff75567d5 in boost::_bi::bind_t<unsigned long, boost::_mfi::mf0<unsigned long, boost::asio::io_service>, boost::_bi::list1<boost::_bi::value<boost::asio::io_service*> > >::operator() (this=0x71a8a8) at /usr/include/boost/bind/bind_template.hpp:20
#35 0x00007ffff755679a in boost::detail::thread_data<boost::_bi::bind_t<unsigned long, boost::_mfi::mf0<unsigned long, boost::asio::io_service>, boost::_bi::list1<boost::_bi::value<boost::asio::io_service*> > > >::run (this=0x71a6f0) at /usr/include/boost/thread/detail/thread.hpp:117
#36 0x00007ffff5892a4a in ?? () from /usr/lib/x86_64-linux-gnu/libboost_thread.so.1.54.0
#37 0x00007ffff66e1182 in start_thread () from /lib/x86_64-linux-gnu/libpthread.so.0
#38 0x00007ffff4c3030d in clone () from /lib/x86_64-linux-gnu/libc.so.6

At depth #10 in the traceback, I tried to print the mutex that seems to produce the error
(gdb) up 10
#10 0x00007ffff756b819 in gazebo::transport::Publisher::OnPublishComplete (this=0x7fff70c788e0, _id=1)
    at /home/asl/SMORES/gazebo_source/gazebo/gazebo/transport/Publisher.cc:227
227   boost::mutex::scoped_lock lock(this->mutex);
(gdb) print this->mutex
$1 = {m = {__data = {__lock = 0, __count = 0, __owner = 0, __nusers = 0, __kind = -1, __spins = 0, __elision = 0, __list = {__prev = 0x0, 
        __next = 0x0}}, __size = '\000' <repeats 16 times>, "\377\377\377\377", '\000' <repeats 19 times>, __align = 0}}

I am new to gazebo and boost. Any suggestion will be great. Thanks!

Originally posted by Jim Jing on Gazebo Answers with karma: 1 on 2014-07-26
Post score: 0

A:

I think this pull request may fix your problem.
We will release Gazebo 4.0 very shortly with the patch in place.

Originally posted by nkoenig with karma: 7676 on 2014-07-31
This answer was ACCEPTED on the original site
Post score: 0

