Q:

waitForTransform fails in Callback

I want to get the transform from "/world" to "/velodyne" so that I can obtain the point cloud in the world frame. The code is as follows:
#include <ros/ros.h>
#include <sensor_msgs/PointCloud2.h>
#include <tf_conversions/tf_eigen.h>
#include <tf/transform_broadcaster.h>
#include <tf/transform_listener.h>
#include <tf/transform_datatypes.h>

void scanCallback(const sensor_msgs::PointCloud2& cloud_msg_in){
    tf::TransformListener tf_listener_;
    if(tf_listener_.waitForTransform("world", "velodyne", cloud_msg_in.header.stamp, ros::Duration(10.0))){
        std::cout<<"[tf is obtained]"<<std::endl;
        tf::StampedTransform tf_transform;
        tf_listener_.lookupTransform("world", "velodyne", cloud_msg_in.header.stamp, tf_transform);
    }else{
        std::cout<<"[wait for tf failed]"<<std::endl;;
    }
}

int main(int argc, char** argv){
    ros::init(argc, argv, "tf_test_node");
    ros::NodeHandle nh;
    ros::Subscriber scan_sub = nh.subscribe("/velodyne_points", 1u, &scanCallback);
    ros::spin();

    return 0;
}

Then, I played a rosbag, but the output of this node was always "[wait for tf failed]". I tried to change "world" to "/world" and "velodyne" to "/velodyne", but it didnot work. I also run rosrun tf tf_echo \world \velodyne, and the output is correct. And the tf_tree of the rosbag is also correct. Moreover, the output of rostopic echo \tf was correct. I have no idea why the code cannot get the \tf, any advises will be appreciated.(The robag can be download from link text)

Originally posted by leon J. on ROS Answers with karma: 3 on 2019-03-16
Post score: 0

A:

TransformListener needs some time to fill its buffer. You don't give it any time, as you construct it in the callback itself.
Create it in main(..) and make sure scanCallback(..) can access it to call lookupTransform(..) on it.

Originally posted by gvdhoorn with karma: 86574 on 2019-03-17
This answer was ACCEPTED on the original site
Post score: 0

Original comments
Comment by leon J. on 2019-03-18:
Thank you for answering, it really works.

