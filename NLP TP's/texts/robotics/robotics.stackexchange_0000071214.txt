Q:

RTABMAP not working with Kinect+Odometry

Hi,
I am trying to use RTAB-MAP with an AGV with a kinnects (Xtion asus pro live) added on top. The system have two computers: 1- (roscore) AGV computer (publishing the odometry, laser scanner, etc..). 2- (where I am running RTAB-map) Computer with kinect.
However, when I launch rtabmap (kinect+odometry), nothing appears. (launching only the kinect works fine).
This is my roslaunch file (including static_tf from base_link to camera_link which is not provided by the AGV):
<launch>
    <!-- TF static transform base_link to camera_link -->
    <node pkg="tf" type="static_transform_publisher" name="link1_broadcaster" args="0 0 1.5 0 0 0 /base_link /camera_link 100" />

    <group ns="rtabmap">

    <node name="rtabmap" pkg="rtabmap_ros" type="rtabmap" output="screen" args="--delete_db_on_start">

        <param name="frame_id" type="string" value="base_link"/>
        <param name="subscribe_depth" type="bool" value="true"/>

        <remap from="odom" to="/odom_comb"/>
        <remap from="rgb/image" to="/camera/rgb/image_rect_color"/>
        <remap from="depth/image" to="/camera/depth_registered/image_raw"/>
        <remap from="rgb/camera_info" to="/camera/rgb/camera_info"/>

        <param name="queue_size" type="int" value="10"/>

        <!-- RTAB-Map's parameters -->

        <param name="RGBD/AngularUpdate" type="string" value="0.01"/>
        <param name="RGBD/LinearUpdate" type="string" value="0.01"/>
        <param name="Rtabmap/TimeThr" type="string" value="700"/>
        <param name="Mem/RehearsalSimilarity" type="string" value="0.45"/>
        <param name="RGBD/OptimizeFromGraphEnd" type="string" value="true"/>

    </node>
    </group>

    <!-- Visualisation RTAB-Map -->
    <node pkg="rtabmap_ros" type="rtabmapviz" name="rtabmapviz"  output="screen">
        <param name="subscribe_depth"     type="bool"   value="true"/>
        <param name="subscribe_laserScan"      type="bool"   value="false"/>
        <param name="subscribe_odom_info" type="bool"   value="false"/>
        <param name="frame_id"            type="string" value="base_link"/>

        <remap from="rgb/image" to="/camera/rgb/image_rect_color"/>
        <remap from="depth/image" to="/camera/depth_registered/image_raw"/>
        <remap from="rgb/camera_info" to="/camera/rgb/camera_info"/>

    </node>

</launch>

I suspect that the problem is on the TF tree due to publishing transforms from 2 different computers. The tf tree (without unning RTABMAP) can be seen here:
agv+static_pub+rtabmap (I cannot attach pictures due to not having enough points on this forum).
Also, the output from roswtf is:
*
WARNING The following node subscriptions are unconnected: 
    * /SerialProxy:
    * /serial0_rx
    * /web_map_generator:
    * /move_base_node/local_costmap/inflated_obstacles
 * /supervisor:
   * /move_base_node/MIRPlannerROS/len_to_goal
 * /rtabmap/rtabmap:
   * /tf_static
   * /rtabmap/move_base/feedback
   * /rtabmap/move_base/status
   * /rtabmap/goal
   * /rtabmap/goal_node
   * /rtabmap/move_base/result
 * /mirEventTrigger:
   * /event_cmd
 * /rtabmapviz:
   * /goal_reached
   * /goal_node
   * /odom
   * /mapData
   * /tf_static
   * /global_path
   * /info
WARNING The following nodes are unexpectedly connected:
 * /laser_back/driver->/roswtf_12815_1452249335691 (/tf)
 * /mirSound->/bridge (/rosout)
 * /laser_front/driver->/roswtf_12815_1452249335691 (/tf)
 * unknown (http://192.168.12.20:40313/)->/mirSound (/mir_sound)
 * unknown (http://192.168.12.20:50779/)->/mirSound (/mir_sound)
 * /bridge->/bridge (/rosout)
 * unknown (http://192.168.12.20:59477/)->/mirSound (/mir_sound)
 * /bridge_api->/bridge (/rosout)
 * /rtabmap/rtabmap->/roswtf_12815_1452249335691 (/tf)
WARNING These nodes have died:
 * mir_param_publisher-1
WARNING Received out-of-date/future transforms:
 * receiving transform from [/StateTF] that differed from ROS time by 28611.7888631s
 * receiving transform from [/transform_footprint] that differed from ROS time by 28611.7991738s
 * receiving transform from [/laser_back/transform] that differed from ROS time by 28611.7992606s
 * receiving transform from [/transform_imu] that differed from ROS time by 28611.7991301s
 * receiving transform from [/mir_amcl] that differed from ROS time by 28611.984325s
 * receiving transform from [/laser_front/transform] that differed from ROS time by 28611.7992704s

Is it possible that the problem is due to this huge TF delays from the AGV related transforms?  What could I do to solve it?
(p.d: this is the output from the roslaunch:
isaac@isaac-Latitude-E6540 ~/Desktop/unblocking_rtab $ roslaunch kinnect_odometry.launch 
... logging to /home/isaac/.ros/log/3f40f5f4-b61b-11e5-93bb-83cec338a840/roslaunch-isaac-Latitude-E6540-10936.log
Checking log directory for disk usage. This may take awhile.
Press Ctrl-C to interrupt
Done checking log file disk usage. Usage is <1GB.

started roslaunch server http://isaac-Latitude-E6540:37077/

SUMMARY
========

PARAMETERS
 * /rosdistro: indigo
 * /rosversion: 1.11.16
 * /rtabmap/rtabmap/Mem/RehearsalSimilarity: 0.45
 * /rtabmap/rtabmap/RGBD/AngularUpdate: 0.01
 * /rtabmap/rtabmap/RGBD/LinearUpdate: 0.01
 * /rtabmap/rtabmap/RGBD/OptimizeFromGraphEnd: true
 * /rtabmap/rtabmap/Rtabmap/TimeThr: 700
 * /rtabmap/rtabmap/frame_id: base_link
 * /rtabmap/rtabmap/queue_size: 10
 * /rtabmap/rtabmap/subscribe_depth: True
 * /rtabmapviz/frame_id: base_link
 * /rtabmapviz/subscribe_depth: True
 * /rtabmapviz/subscribe_laserScan: False
 * /rtabmapviz/subscribe_odom_info: False

NODES
  /rtabmap/
    rtabmap (rtabmap_ros/rtabmap)
  /
    link1_broadcaster (tf/static_transform_publisher)
    rtabmapviz (rtabmap_ros/rtabmapviz)

ROS_MASTER_URI=http://192.168.12.20:11311

core service [/rosout] found
process[link1_broadcaster-1]: started with pid [10945]
process[rtabmap/rtabmap-2]: started with pid [10946]
process[rtabmapviz-3]: started with pid [10950]
[ INFO] [1452248271.823447177]: Starting node...
[ INFO] [1452248271.858289290]: Starting node...
[ INFO] [1452248271.955024955]: rtabmapviz: Using configuration from "/home/isaac/.ros/rtabmapGUI.ini"
[ INFO] [1452248272.031309782]: rtabmap: frame_id = base_link
[ INFO] [1452248272.031363336]: rtabmap: map_frame_id = map
[ INFO] [1452248272.031383702]: rtabmap: queue_size = 10
[ INFO] [1452248272.031405005]: rtabmap: tf_delay = 0.050000
[ INFO] [1452248272.031425694]: rtabmap: depth_cameras = 1
[ INFO] [1452248272.664404485]: Reading parameters from the ROS server...
[ INFO] [1452248272.878213850]: Setting RTAB-Map parameter "Mem/RehearsalSimilarity"="0.45"
[ INFO] [1452248273.085919415]: Parameters read = 0
[ INFO] [1452248273.338840271]: Setting RTAB-Map parameter "RGBD/AngularUpdate"="0.01"
[ INFO] [1452248273.356835074]: 
/rtabmapviz subscribed to:
   /camera/rgb/image_rect_color,
   /camera/depth_registered/image_raw,
   /camera/rgb/camera_info,
   /odom
[ INFO] [1452248273.365194412]: Setting RTAB-Map parameter "RGBD/LinearUpdate"="0.01"
[ INFO] [1452248273.422709134]: rtabmapviz started.
[ INFO] [1452248273.465536891]: Setting RTAB-Map parameter "RGBD/OptimizeFromGraphEnd"="true"
[ INFO] [1452248273.721767461]: Setting RTAB-Map parameter "Rtabmap/TimeThr"="700"
[ INFO] [1452248274.500014304]: RTAB-Map rate detection = 1.000000 Hz
[ INFO] [1452248274.500153014]: rtabmap: Deleted database "/home/isaac/.ros/rtabmap.db" (--delete_db_on_start is set).
[ INFO] [1452248274.500178125]: rtabmap: Using database from "/home/isaac/.ros/rtabmap.db".
[ INFO] [1452248274.647943449]: rtabmap: Database version = "0.10.10".
[ INFO] [1452248274.928178272]: Registering Depth callback...
[ INFO] [1452248274.929296254]: 
/rtabmap/rtabmap subscribed to:
   /camera/rgb/image_rect_color,
   /camera/depth_registered/image_raw,
   /camera/rgb/camera_info,
   /odom_comb
[ INFO] [1452248274.929421499]: rtabmap 0.10.10 started...

Thanks a lot.

Originally posted by maik_mico on ROS Answers with karma: 3 on 2016-01-08
Post score: 0

Original comments
Comment by maik_mico on 2016-01-09:
I updated the links to the goggle drive files (I realized that people could not see them).
Sorry for any inconvenience
Comment by gvdhoorn on 2016-01-09:
Please include all the relevant (console) output in your question proper. If the google drive links ever go dead, this question (and any potential answers) will become useless.
Comment by maik_mico on 2016-01-11:
I have modified the original message including the relevant console output, roslaunch, etc.. The only thing I could not upload yet is a picture with the tf tree..
Comment by maik_mico on 2016-01-11:
Hi Mathieu,
I am receiving the topics correctly (odom_comb topic 40hz, camera topics 30hz). However rtabmap is not outputing anything on the console

A:

Does /odom_comb have a timestamp set in the topic header? Or maybe the clocks from the computers are not synchronized. In roswtf above, you have a warning about out-of-data transforms with a delay of 28611.7888631s. You can compare the topic stamps with: $rostopic echo /odom_comb/header/stamp

Originally posted by matlabbe with karma: 6409 on 2016-01-11
This answer was ACCEPTED on the original site
Post score: 0

Original comments
Comment by maik_mico on 2016-01-11:
Problem solved. I had the same suspicion about Time stamps difference. It was in the order of more than 20000secs. So I created a node that subscribes and publishes the relevant transforms and odom_comb with new names and the local machine time stamp and everything works
Comment by maik_mico on 2016-01-11:
Thank you very much Mathieu. Should I document the solution and writte it on this post so it is also useful for other users? Or I just mark the previous message saying that its solved?
Comment by gvdhoorn on 2016-01-11:
@maik_mico: if possible, just synchronise the time of the involved PCs. Use something like chrony or ntp. No need to write custom nodes.
Comment by maik_mico on 2016-01-11:
I agree that would be the most optimum solution.. However I cannot access the computer from the AGV so I can only build things on top of it from a separate computer.
Comment by gvdhoorn on 2016-01-11:
So you can install and run ROS on the AGV computer, but can't change its time? What make and model are we talking about?
Comment by maik_mico on 2016-01-11:
Not exactly. The AGV it's developed under ROS but I cannot login to it's computer, so I just connected my computer to the same network and did an export ROS_MASTER_URI... Thus, I can access all its topics but cannot modify anything from its software. P.d: the AGV it's the MiR100
Comment by gvdhoorn on 2016-01-11:
Well, you could always see whether the AGV is already running an NTP or Chrony server. Or, alternatively, you could set the clock of your addon PC to match the clock on the AGV.
In any case, perhaps just contact them and ask?
Comment by maik_mico on 2016-01-11:
I will ask them if they are running NTP or Chrony. Thanks for the tip
Comment by gvdhoorn on 2016-01-11:
You could just run an nmap IP_OF_AGV and see what comes out.

