Q:

cant assign the value to 'cmd_msg.data' in runtime

I am doing a stepper motor programming.what i want is "when i enter an angle on command line,then stepper should rotate that angle".
but i cant assign the value in runtime. help me please.
#include <ros.h>
#include <std_msgs/Empty.h>
#include <std_msgs/UInt16.h>
signed int angle;
int enable2 = 13;
const int stepPin = 9; 
const int dirPin = 8;
int x;

ros::NodeHandle  nh;
void pwm( const std_msgs::UInt16& cmd_msg)
{
  
 analogWrite(enable2, cmd_msg.data);
angle=analogRead(enable2);
 
      
}

ros::Subscriber<std_msgs::UInt16> sub("servo", pwm);

void setup(){
 // pinMode(angle, OUTPUT); 
 pinMode(enable2, OUTPUT);   
 pinMode(stepPin,OUTPUT); 
  pinMode(dirPin,OUTPUT);
  nh.initNode();
  nh.subscribe(sub);
  
 // servo.attach(9); //attach it to pin 9
}

void loop()
{
   
   if (angle<0)
     {
       cw();
       delay(100);
      }
 else
   {
    ccw();
    delay(100);
   }
delay(10000);
nh.spinOnce();
  delay(1);
}
void cw()
{
  digitalWrite(dirPin,LOW); 
  for(x = 0; x < 17.77*(angle*-1); x++) {
    digitalWrite(stepPin,HIGH); 
    delayMicroseconds(500); 
    digitalWrite(stepPin,LOW); 
    delayMicroseconds(500); 
  }}
  void ccw()
{
  digitalWrite(dirPin,HIGH); 
  for(x = 0; x < 17.77*angle; x++) {
    digitalWrite(stepPin,HIGH); 
    delayMicroseconds(500); 
    digitalWrite(stepPin,LOW); 
    delayMicroseconds(500); 
  }}

Originally posted by sudo_melvinyesudas on ROS Answers with karma: 54 on 2018-01-10
Post score: 0

A:

gvdhoorn is right. You are setting up a subscriber with a callback function called cmd_msg, but cmd_msg has not been defined, further more you seem to have coded your callback function into the loop function so it would run continuously.
You'll need to define a function called cmd_msg and access the angle that the message contains as shown below:
void cmd_msg(const std_msgs::UInt16::ConstPtr& msg)
{
  int angle = msg.data;
  ...
  ...
}

Then add the rest of the code you have inside loop into this callback function.
Have a look at the publisher and subscriber example for some pointers.
Hope this helps.

Originally posted by PeteBlackerThe3rd with karma: 9529 on 2018-01-10
This answer was ACCEPTED on the original site
Post score: 0

Original comments
Comment by gvdhoorn on 2018-01-10:
Note that the OP is using rosserial. The tutorial may help, but could also confuse.
Comment by sudo_melvinyesudas on 2018-01-10:
brothers, can you check the question once more ? i just edited my code.thats why.
and now the problem is i csnt assign the value in  runtime . and it shows lost the sync with device.
Comment by gvdhoorn on 2018-01-10:
I'm not your brother, but:
void loop(){
  ..
  delay(10000);
}

you cannot delay the loop() for 10 seconds like that.
Comment by sudo_melvinyesudas on 2018-01-10:
ok sorry.
but still it wont make any difference.
analogWrite(enable2, cmd_msg.data);
    angle=analogRead(enable2);

is it right ?thus can i pass the value which i enter in cammandline to variable angle ?

